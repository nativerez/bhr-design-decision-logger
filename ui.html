<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    body {
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      background: #fff;
      padding: 16px;
      overflow-x: hidden;
      width: 640px;
      height: 840px;
    }
    h2 {
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 20px;
    }
    h3 {
      margin-bottom: 16px;
      font-weight: 500;
      font-size: 16px;
    }
    .tab-container {
      display: flex;
      border-bottom: 1px solid #e5e5e5;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 500;
      font-size: 15px;
      color: #333;
    }
    .tab.active {
      border-bottom: 2px solid #18a0fb;
      color: #18a0fb;
    }
    /* These classes are kept for backward compatibility */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 14px;
    }
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-size: 14px;
    }
    textarea {
      height: 100px;
      resize: vertical;
    }
    .link-item {
      display: flex;
      margin-bottom: 10px;
    }
    .link-item input {
      flex: 1;
      margin-right: 10px;
    }
    .link-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
    }
    .pros-cons {
      display: flex;
      gap: 16px;
    }
    .pros, .cons {
      flex: 1;
    }
    .list-item {
      display: flex;
      margin-bottom: 8px;
    }
    .list-item input {
      flex: 1;
      margin-right: 10px;
    }
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .tag {
      background: #f0f0f0;
      padding: 6px 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      font-size: 13px;
    }
    .tag span {
      margin-right: 6px;
    }
    .tag button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }
    
    /* Tag suggestions dropdown */
    .tag-suggestions {
      position: absolute;
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 150px;
      overflow-y: auto;
      width: calc(100% - 40px);
      z-index: 100;
      display: none;
    }
    
    .tag-suggestions.visible {
      display: block;
    }
    
    .tag-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .tag-suggestion:hover {
      background-color: #f5f5f5;
    }
    
    /* Highlighted suggestion */
    .tag-suggestion.highlighted {
      background-color: #e9f5ff;
    }
    
    .button {
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }
    .button.secondary {
      background: #f5f5f5;
      color: #333;
      border: 1px solid #e5e5e5;
    }
    .button.danger {
      background: transparent;
      color: #ff5252
    }
    .decision-list {
      margin-top: 16px;
    }
    .decision-card {
      padding: 16px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      margin-bottom: 16px;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: relative;
    }
    .decision-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .decision-title {
      font-weight: 600;
      font-size: 16px;
      padding-right: 75px; /* Make room for the status badge */
    }
    .decision-meta {
      font-size: 12px;
      color: #888;
      margin-bottom: 10px;
    }
    .decision-context {
      font-size: 14px;
      margin-bottom: 10px;
    }
    .decision-actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
    }
    .section {
      margin-bottom: 20px;
    }
    .filter-bar {
      display: flex;
      margin-bottom: 16px;
      gap: 10px;
    }
    .filter-bar input, 
    .filter-bar select {
      flex: 1;
      min-width: 0; /* Prevents flex items from overflowing */
      font-size: 14px;
    }
    
    /* History tab background */
    #content-history {
      background-color: #f5f5f5;
      padding: 16px;
      border-radius: 6px;
      min-height: calc(100vh - 80px);
    }
    
    /* New styles for detail panel */
    .decision-detail-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 10;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      transition: right 0.3s ease;
      overflow-y: auto;
    }
    .decision-detail-panel.active {
      right: 0;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eee;
    }
    .detail-title {
      font-weight: 600;
      font-size: 20px;
      color: #333;
      flex: 1;
    }
    .detail-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      margin-left: 10px;
    }
    .detail-header .status-badge {
      position: static;
      margin-left: 10px;
      margin-right: 10px;
    }
    .detail-section {
      margin-bottom: 20px;
    }
    .detail-section-title {
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 16px;
      color: #666;
    }
    .detail-section-content {
      margin-bottom: 20px;
      line-height: 1.6;
      font-size: 14px;
    }
    .detail-meta {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #888;
    }
    .detail-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .detail-link {
      display: block;
      color: #18a0fb;
      text-decoration: none;
      font-size: 14px;
    }
    .detail-pros-cons {
      display: flex;
      gap: 16px;
      margin-top: 10px;
    }
    .detail-pros, .detail-cons {
      flex: 1;
      padding: 12px;
      border-radius: 4px;
    }
    .detail-pros {
      background-color: #f2fbf2;
    }
    .detail-cons {
      background-color: #fff0f0;
    }
    .detail-list-title {
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .detail-list {
      list-style-position: inside;
      padding-left: 6px;
      font-size: 14px;
    }
    .detail-list li {
      margin-bottom: 6px;
    }
    .detail-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    .status-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    .status-proposed {
      background-color: #E3F2FD;
      color: #0D47A1;
    }
    .status-accepted {
      background-color: #E8F5E9;
      color: #1B5E20;
    }
    .status-rejected {
      background-color: #FFEBEE;
      color: #B71C1C;
    }
    .status-deprecated {
      background-color: #EFEBE9;
      color: #3E2723;
    }
    .status-superseded {
      background-color: #F3E5F5;
      color: #4A148C;
    }
    
    /* New action button style */
    .action-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: #18a0fb;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 100;
      transition: all 0.2s ease;
      font-size: 24px;
      border: none;
    }
    
    .action-button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* Decision form panel style */
    .decision-form-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 10;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      transition: right 0.3s ease;
      overflow-y: auto;
    }
    
    .decision-form-panel.active {
      right: 0;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e5e5;
      margin-bottom: 20px;
      padding-bottom: 12px;
    }
    
    .header-title {
      font-weight: 600;
      font-size: 18px;
      color: #333;
    }
    
    .content-main {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">ðŸ“‹ Decision History</div>
  </div>

  <!-- Decision History -->
  <div id="content-history" class="content-main">
    <div class="filter-bar">
      <input type="text" id="search-input" placeholder="Search decisions...">
      <select id="filter-tags">
        <option value="">All tags</option>
      </select>
      <select id="filter-status">
        <option value="">All statuses</option>
        <option value="proposed">Proposed</option>
        <option value="accepted">Accepted</option>
        <option value="rejected">Rejected</option>
        <option value="deprecated">Deprecated</option>
        <option value="superseded">Superseded</option>
      </select>
      <select id="sort-decisions">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="az">A-Z</option>
        <option value="za">Z-A</option>
      </select>
    </div>
    <div class="decision-list" id="decision-list">
      <!-- Decision cards will be inserted here -->
      <div class="empty-state">No decisions recorded yet.</div>
    </div>
  </div>

  <!-- New Decision Action Button -->
  <button id="new-decision-btn" class="action-button">+</button>

  <!-- Decision Form Panel (initially hidden) -->
  <div id="decision-form-panel" class="decision-form-panel">
    <div class="detail-header">
      <div class="detail-title" id="form-title">New Decision</div>
      <button class="detail-close" id="form-close">âœ•</button>
    </div>
    
    <form id="decision-form">
      <!-- Figma Element Section -->
      <div class="section">
        <h3>Linked Figma Element</h3>
        <div id="figma-node-info" class="figma-node-info">
          <div id="no-selection" style="color: #888; font-style: italic;">No element selected. Select a Figma element before creating a decision to link it.</div>
          <div id="node-selection" style="display: none;">
            <div class="tag" style="background-color: #E9F5FF; color: #007ACC;">
              <span id="node-page" style="color: #888; margin-right: 5px; font-size: 11px;"></span>
              <span id="node-name">Element name</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="title">Decision Title</label>
        <input type="text" id="title" placeholder="What is the decision about?" required>
      </div>
      <div class="form-group">
        <label for="context">Context</label>
        <textarea id="context" placeholder="What is the background for this decision?" required></textarea>
      </div>
      <div class="form-group">
        <label for="status">Status</label>
        <select id="status" required>
          <option value="proposed">Proposed</option>
          <option value="accepted">Accepted</option>
          <option value="rejected">Rejected</option>
          <option value="deprecated">Deprecated</option>
          <option value="superseded">Superseded</option>
        </select>
      </div>
      <div class="form-group">
        <label for="rationale">Rationale</label>
        <textarea id="rationale" placeholder="Why was this decision made?" required></textarea>
      </div>
      
      <!-- Links Section -->
      <div class="section">
        <h3>Links & References</h3>
        <div id="links-container">
          <div class="link-item">
            <input type="text" placeholder="Title" class="link-title">
            <input type="text" placeholder="URL" class="link-url">
            <button type="button" class="button secondary remove-link">âœ•</button>
          </div>
        </div>
        <button type="button" id="add-link" class="button secondary">Add Link</button>
      </div>
      
      <!-- Pros & Cons Section -->
      <div class="section">
        <h3>Pros & Cons</h3>
        <div class="pros-cons">
          <div class="pros">
            <label>Pros</label>
            <div id="pros-container">
              <div class="list-item">
                <input type="text" class="pro-item" placeholder="Add a pro">
                <button type="button" class="button secondary remove-item">âœ•</button>
              </div>
            </div>
            <button type="button" id="add-pro" class="button secondary">Add Pro</button>
          </div>
          <div class="cons">
            <label>Cons</label>
            <div id="cons-container">
              <div class="list-item">
                <input type="text" class="con-item" placeholder="Add a con">
                <button type="button" class="button secondary remove-item">âœ•</button>
              </div>
            </div>
            <button type="button" id="add-con" class="button secondary">Add Con</button>
          </div>
        </div>
      </div>
      
      <!-- Tags Section -->
      <div class="section">
        <h3>Tags</h3>
        <div style="position: relative;">
          <input type="text" id="tag-input" placeholder="Add tags (comma separated)">
          <div id="tag-suggestions" class="tag-suggestions"></div>
        </div>
        <div class="tags-container" id="tags-container">
          <!-- Tags will be inserted here -->
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit" id="save-decision" class="button">Save Decision</button>
        <button type="button" id="cancel" class="button secondary">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Edit Decision Modal (hidden by default) -->
  <div id="edit-modal" style="display: none;">
    <!-- Edit form will be similar to new decision form -->
  </div>
  
  <!-- Decision Detail Panel (hidden by default) -->
  <div id="decision-detail-panel" class="decision-detail-panel">
    <div class="detail-header">
      <div class="detail-title" id="detail-title">Decision Title</div>
      <div class="status-badge" id="detail-status">Status</div>
      <button class="detail-close" id="detail-close">âœ•</button>
    </div>
    <div class="detail-meta">
      <div id="detail-author">By Author</div>
      <div id="detail-date">On Date</div>
    </div>
    
    <div class="detail-section">
      <div class="detail-section-title">Context</div>
      <div class="detail-section-content" id="detail-context">Context content will go here</div>
    </div>
    
    <div class="detail-section">
      <div class="detail-section-title">Rationale</div>
      <div class="detail-section-content" id="detail-rationale">Rationale content will go here</div>
    </div>
    
    <div id="detail-links-section" class="detail-section" style="display: none;">
      <div class="detail-section-title">Links & References</div>
      <div class="detail-links" id="detail-links">
        <!-- Links will be inserted here -->
      </div>
    </div>
    
    <div id="detail-pros-cons-section" class="detail-section" style="display: none;">
      <div class="detail-section-title">Pros & Cons</div>
      <div class="detail-pros-cons">
        <div class="detail-pros">
          <div class="detail-list-title">Pros</div>
          <ul class="detail-list" id="detail-pros">
            <!-- Pros will be inserted here -->
          </ul>
        </div>
        <div class="detail-cons">
          <div class="detail-list-title">Cons</div>
          <ul class="detail-list" id="detail-cons">
            <!-- Cons will be inserted here -->
          </ul>
        </div>
      </div>
    </div>
    
    <div id="detail-tags-section" class="detail-section" style="display: none;">
      <div class="detail-section-title">Tags</div>
      <div class="tags-container" id="detail-tags">
        <!-- Tags will be inserted here -->
      </div>
    </div>
    
    <div id="detail-node-section" class="detail-section" style="display: none;">
      <div class="detail-section-title">Linked Figma Element</div>
      <div id="detail-node-info">
        <!-- Node info will be inserted here -->
      </div>
    </div>
    
    <div class="detail-actions">
      <button class="button secondary" id="detail-edit-button">Edit Decision</button>
      <button class="button secondary danger" id="detail-delete-button">Delete</button>
    </div>
  </div>

  <script>
    // Global variables
    let decisions = [];
    let currentUser = null;
    let editingDecisionId = null;
    let currentTags = [];
    let selectedNodeId = null;
    let selectedNodeName = null;
    let selectedPageName = null;
    let currentDetailDecisionId = null;
    let allUniqueTags = new Set(); // Store all unique tags for autocomplete
    let currentTagSuggestions = []; // Current suggestions based on user input
    let highlightedSuggestionIndex = -1; // Currently highlighted suggestion
    
    // Get current user info
    parent.postMessage({ pluginMessage: { type: 'get-user-info' } }, '*');

    // New Decision Button - show the form panel
    document.getElementById('new-decision-btn').addEventListener('click', showDecisionForm);
    
    // Close form panel
    document.getElementById('form-close').addEventListener('click', hideDecisionForm);
    
    function showDecisionForm() {
      // Reset the form first
      resetForm();
      // Set title to "New Decision" if not editing
      if (!editingDecisionId) {
        document.getElementById('form-title').textContent = 'New Decision';
      }
      // Show the form panel
      document.getElementById('decision-form-panel').classList.add('active');
      // Hide the "New Decision" button when form is shown
      document.getElementById('new-decision-btn').style.display = 'none';
    }
    
    function hideDecisionForm() {
      document.getElementById('decision-form-panel').classList.remove('active');
      // Reset the form when hiding
      resetForm();
      // Show the "New Decision" button when form is closed
      document.getElementById('new-decision-btn').style.display = 'flex';
    }
    
    function resetForm() {
      // Reset form and editing state
      document.getElementById('decision-form').reset();
      document.getElementById('links-container').innerHTML = '';
      document.getElementById('pros-container').innerHTML = '';
      document.getElementById('cons-container').innerHTML = '';
      currentTags = [];
      renderTags();
      editingDecisionId = null;
      document.getElementById('save-decision').textContent = 'Save Decision';
      
      // Add empty fields back
      addLinkField();
      addListItem('pros-container', 'pro-item');
      addListItem('cons-container', 'con-item');
    }

    // Handle form submission
    document.getElementById('decision-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const title = document.getElementById('title').value;
      const context = document.getElementById('context').value;
      const rationale = document.getElementById('rationale').value;
      const status = document.getElementById('status').value;
      
      // Gather links
      const links = [];
      document.querySelectorAll('.link-item').forEach(linkItem => {
        const titleInput = linkItem.querySelector('.link-title');
        const urlInput = linkItem.querySelector('.link-url');
        
        if (titleInput.value && urlInput.value) {
          links.push({
            title: titleInput.value,
            url: urlInput.value
          });
        }
      });
      
      // Gather pros
      const pros = [];
      document.querySelectorAll('.pro-item').forEach(input => {
        if (input.value) pros.push(input.value);
      });
      
      // Gather cons
      const cons = [];
      document.querySelectorAll('.con-item').forEach(input => {
        if (input.value) cons.push(input.value);
      });
      
      // Check if we're editing or creating
      if (editingDecisionId) {
        // Editing an existing decision
        parent.postMessage({
          pluginMessage: {
            type: 'edit-decision',
            decision: {
              id: editingDecisionId,
              title,
              context,
              rationale,
              links,
              pros,
              cons,
              tags: currentTags,
              nodeId: selectedNodeId,
              nodeName: selectedNodeName,
              pageName: selectedPageName,
              status // Include status when editing a decision
            }
          }
        }, '*');
      } else {
        // Creating a new decision
        parent.postMessage({
          pluginMessage: {
            type: 'create-decision',
            title,
            context,
            rationale,
            links,
            pros,
            cons,
            tags: currentTags,
            nodeId: selectedNodeId,
            nodeName: selectedNodeName,
            pageName: selectedPageName, // Include page name when creating a decision
            status // Include status when creating a decision
          }
        }, '*');
      }
      
      // Hide the form panel after submission
      document.getElementById('decision-form-panel').classList.remove('active');
      
      // Show the "New Decision" button again after submission
      document.getElementById('new-decision-btn').style.display = 'flex';
    });

    // Add new link input field
    document.getElementById('add-link').addEventListener('click', addLinkField);
    
    function addLinkField() {
      const container = document.getElementById('links-container');
      const linkItem = document.createElement('div');
      linkItem.classList.add('link-item');
      linkItem.innerHTML = `
        <input type="text" placeholder="Title" class="link-title">
        <input type="text" placeholder="URL" class="link-url">
        <button type="button" class="button secondary remove-link">âœ•</button>
      `;
      container.appendChild(linkItem);
      
      // Add event listener to the remove button
      linkItem.querySelector('.remove-link').addEventListener('click', () => {
        container.removeChild(linkItem);
      });
    }
    
    // Add event listeners for existing remove buttons
    document.querySelectorAll('.remove-link').forEach(button => {
      button.addEventListener('click', (e) => {
        const linkItem = e.target.closest('.link-item');
        linkItem.parentNode.removeChild(linkItem);
      });
    });
    
    // Add pro item
    document.getElementById('add-pro').addEventListener('click', () => {
      addListItem('pros-container', 'pro-item');
    });
    
    // Add con item
    document.getElementById('add-con').addEventListener('click', () => {
      addListItem('cons-container', 'con-item');
    });
    
    function addListItem(containerId, className) {
      const container = document.getElementById(containerId);
      const listItem = document.createElement('div');
      listItem.classList.add('list-item');
      listItem.innerHTML = `
        <input type="text" class="${className}" placeholder="Add an item">
        <button type="button" class="button secondary remove-item">âœ•</button>
      `;
      container.appendChild(listItem);
      
      // Add event listener to the remove button
      listItem.querySelector('.remove-item').addEventListener('click', () => {
        container.removeChild(listItem);
      });
    }
    
    // Handle tag input - enhanced with autocomplete is implemented above
    
    function addTag(tagText) {
      currentTags.push(tagText);
      renderTags();
    }
    
    function renderTags() {
      const container = document.getElementById('tags-container');
      container.innerHTML = '';
      
      currentTags.forEach(tag => {
        const tagElement = document.createElement('div');
        tagElement.classList.add('tag');
        tagElement.innerHTML = `
          <span>${tag}</span>
          <button type="button" data-tag="${tag}">âœ•</button>
        `;
        container.appendChild(tagElement);
        
        // Add event listener to remove tag
        tagElement.querySelector('button').addEventListener('click', (e) => {
          const tagToRemove = e.target.dataset.tag;
          currentTags = currentTags.filter(t => t !== tagToRemove);
          renderTags();
        });
      });
    }
    
    // Cancel button
    document.getElementById('cancel').addEventListener('click', () => {
      // Reset form
      resetForm();
      
      // Hide the form panel
      document.getElementById('decision-form-panel').classList.remove('active');
      
      // Show the "New Decision" button again
      document.getElementById('new-decision-btn').style.display = 'flex';
    });
    
    // Search and filter functionality
    document.getElementById('search-input').addEventListener('input', filterDecisions);
    document.getElementById('filter-tags').addEventListener('change', filterDecisions);
    document.getElementById('filter-status').addEventListener('change', filterDecisions);
    document.getElementById('sort-decisions').addEventListener('change', filterDecisions);
    
    function filterDecisions() {
      const searchText = document.getElementById('search-input').value.toLowerCase();
      const tagFilter = document.getElementById('filter-tags').value;
      const statusFilter = document.getElementById('filter-status').value;
      const sortOption = document.getElementById('sort-decisions').value;
      
      const filtered = decisions.filter(decision => {
        // Search text filter
        const matchesSearch = searchText === '' || 
          decision.title.toLowerCase().includes(searchText) || 
          decision.context.toLowerCase().includes(searchText) ||
          decision.rationale.toLowerCase().includes(searchText);
        
        // Tag filter
        const matchesTag = tagFilter === '' || 
          (decision.tags && decision.tags.includes(tagFilter));
        
        // Status filter
        const matchesStatus = statusFilter === '' || decision.status === statusFilter;
        
        return matchesSearch && matchesTag && matchesStatus;
      });
      
      renderDecisionsList(filtered, sortOption);
    }
    
    // Render decisions list
    function renderDecisionsList(decisionsToRender = decisions, sortOption = 'newest') {
      const container = document.getElementById('decision-list');
      container.innerHTML = '';
      
      if (decisionsToRender.length === 0) {
        container.innerHTML = '<div class="empty-state">No decisions found.</div>';
        return;
      }
      
      // Sort decisions based on the selected sort option
      decisionsToRender.sort((a, b) => {
        switch (sortOption) {
          case 'newest':
            return b.timestamp - a.timestamp;
          case 'oldest':
            return a.timestamp - b.timestamp;
          case 'az':
            return a.title.localeCompare(b.title);
          case 'za':
            return b.title.localeCompare(a.title);
          default:
            return b.timestamp - a.timestamp;
        }
      });
      
      decisionsToRender.forEach(decision => {
        const card = document.createElement('div');
        card.classList.add('decision-card');
        
        const date = new Date(decision.timestamp);
        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        
        // Prepare the Figma node link section if it exists
        let figmaNodeSection = '';
        if (decision.nodeId && decision.nodeName) {
          const pageNameDisplay = decision.pageName ? 
            `<span style="color: #888; margin-right: 5px; font-size: 11px; display: inline-block;">${decision.pageName}</span>` : '';
            
          figmaNodeSection = `
            <div class="figma-node-link" style="margin-top: 8px;">
              <div class="tag" style="background-color: #E9F5FF; color: #007ACC; display: inline-flex; cursor: pointer;" data-node-id="${decision.nodeId}" data-page-name="${decision.pageName || ''}">
                ${pageNameDisplay}
                <span>${decision.nodeName}</span>
              </div>
            </div>`;
        }
        
        card.innerHTML = `
          <div class="decision-header">
            <div class="decision-title">${decision.title}</div>
            <div class="status-badge status-${(decision.status || 'proposed').toLowerCase()}">${decision.status || 'Proposed'}</div>
          </div>
          <div class="decision-meta">
            By ${decision.author} on ${formattedDate}
          </div>
          <div class="decision-context">${decision.context}</div>
          ${decision.tags && decision.tags.length > 0 ? 
            `<div class="tags-container">
              ${decision.tags.map(tag => `<div class="tag"><span>${tag}</span></div>`).join('')}
            </div>` : ''}
          ${figmaNodeSection}
          <div class="decision-actions">
            <button class="button secondary view-details" data-id="${decision.id}">View Details</button>
            <button class="button secondary edit-decision" data-id="${decision.id}">Edit</button>
            <button class="button secondary danger delete-decision" data-id="${decision.id}">Delete</button>
          </div>
        `;
        
        container.appendChild(card);
        
        // Add event listeners
        card.querySelector('.view-details').addEventListener('click', () => {
          viewDecisionDetails(decision.id);
        });
        
        card.querySelector('.edit-decision').addEventListener('click', () => {
          editDecision(decision.id);
        });
        
        card.querySelector('.delete-decision').addEventListener('click', () => {
          if (confirm('Are you sure you want to delete this decision?')) {
            deleteDecision(decision.id);
          }
        });
        
        // Add node navigation event listener if there's a linked node
        const figmaNodeLink = card.querySelector('.figma-node-link .tag');
        if (figmaNodeLink) {
          figmaNodeLink.addEventListener('click', () => {
            const nodeId = figmaNodeLink.dataset.nodeId;
            navigateToNode(nodeId, decision.pageName);
          });
        }
      });
    }
    
    // Function to navigate to a Figma node
    function navigateToNode(nodeId, pageName) {
      if (!nodeId) return;
      
      parent.postMessage({
        pluginMessage: {
          type: 'navigate-to-node',
          nodeId,
          pageName
        }
      }, '*');
    }
    
    // Function to show the detail panel
    function viewDecisionDetails(id) {
      // Find the decision with the given ID
      const decision = decisions.find(d => d.id === id);
      if (!decision) return;
      
      currentDetailDecisionId = id;
      
      // Set details in the panel
      const detailPanel = document.getElementById('decision-detail-panel');
      
      // Set basic info
      document.getElementById('detail-title').textContent = decision.title;
      
      // Set status with proper styling
      const statusElement = document.getElementById('detail-status');
      const statusText = decision.status || 'Proposed';
      const statusClass = `status-${statusText.toLowerCase()}`;
      statusElement.textContent = statusText;
      statusElement.className = 'status-badge ' + statusClass;
      
      // Format date
      const date = new Date(decision.timestamp);
      const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      
      document.getElementById('detail-author').textContent = `By ${decision.author}`;
      document.getElementById('detail-date').textContent = `On ${formattedDate}`;
      
      // Set content
      document.getElementById('detail-context').textContent = decision.context;
      document.getElementById('detail-rationale').textContent = decision.rationale;
      
      // Handle links section
      const linksSection = document.getElementById('detail-links-section');
      const linksContainer = document.getElementById('detail-links');
      
      if (decision.links && decision.links.length > 0) {
        linksSection.style.display = 'block';
        linksContainer.innerHTML = '';
        
        decision.links.forEach(link => {
          const linkElement = document.createElement('a');
          linkElement.classList.add('detail-link');
          linkElement.href = link.url;
          linkElement.target = '_blank';
          linkElement.textContent = link.title;
          linksContainer.appendChild(linkElement);
        });
      } else {
        linksSection.style.display = 'none';
      }
      
      // Handle pros and cons section
      const prosConsSection = document.getElementById('detail-pros-cons-section');
      const prosList = document.getElementById('detail-pros');
      const consList = document.getElementById('detail-cons');
      
      if ((decision.pros && decision.pros.length > 0) || (decision.cons && decision.cons.length > 0)) {
        prosConsSection.style.display = 'block';
        
        // Populate pros
        prosList.innerHTML = '';
        if (decision.pros && decision.pros.length > 0) {
          decision.pros.forEach(pro => {
            const li = document.createElement('li');
            li.textContent = pro;
            prosList.appendChild(li);
          });
        } else {
          prosList.innerHTML = '<li style="font-style: italic; color: #888;">None specified</li>';
        }
        
        // Populate cons
        consList.innerHTML = '';
        if (decision.cons && decision.cons.length > 0) {
          decision.cons.forEach(con => {
            const li = document.createElement('li');
            li.textContent = con;
            consList.appendChild(li);
          });
        } else {
          consList.innerHTML = '<li style="font-style: italic; color: #888;">None specified</li>';
        }
      } else {
        prosConsSection.style.display = 'none';
      }
      
      // Handle tags section
      const tagsSection = document.getElementById('detail-tags-section');
      const tagsContainer = document.getElementById('detail-tags');
      
      if (decision.tags && decision.tags.length > 0) {
        tagsSection.style.display = 'block';
        tagsContainer.innerHTML = '';
        
        decision.tags.forEach(tag => {
          const tagElement = document.createElement('div');
          tagElement.classList.add('tag');
          tagElement.innerHTML = `<span>${tag}</span>`;
          tagsContainer.appendChild(tagElement);
        });
      } else {
        tagsSection.style.display = 'none';
      }
      
      // Handle linked node section
      const nodeSection = document.getElementById('detail-node-section');
      const nodeContainer = document.getElementById('detail-node-info');
      
      if (decision.nodeId && decision.nodeName) {
        nodeSection.style.display = 'block';
        const pageNameDisplay = decision.pageName ? 
          `<span style="color: #888; margin-right: 5px; font-size: 11px; display: inline-block;">${decision.pageName}</span>` : '';
          
        nodeContainer.innerHTML = `
          <div class="tag" style="background-color: #E9F5FF; color: #007ACC; display: inline-flex; cursor: pointer;" data-node-id="${decision.nodeId}">
            ${pageNameDisplay}
            <span>${decision.nodeName}</span>
          </div>
        `;
        
        // Add click event to the node tag
        nodeContainer.querySelector('.tag').addEventListener('click', () => {
          navigateToNode(decision.nodeId, decision.pageName);
        });
      } else {
        nodeSection.style.display = 'none';
      }
      
      // Set up action buttons
      document.getElementById('detail-edit-button').addEventListener('click', () => {
        detailPanel.classList.remove('active');
        editDecision(decision.id);
      });
      
      document.getElementById('detail-delete-button').addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this decision?')) {
          detailPanel.classList.remove('active');
          deleteDecision(decision.id);
        }
      });
      
      // Set up close button
      document.getElementById('detail-close').addEventListener('click', () => {
        detailPanel.classList.remove('active');
        currentDetailDecisionId = null;
        
        // Ensure the "New Decision" button is shown when detail panel is closed
        // Only if the form panel is not active
        if (!document.getElementById('decision-form-panel').classList.contains('active')) {
          document.getElementById('new-decision-btn').style.display = 'flex';
        }
      });
      
      // Show the panel with animation
      detailPanel.classList.add('active');
    }
    
    function editDecision(id) {
      // Load the decision data into the form and switch to the edit mode
      const decision = decisions.find(d => d.id === id);
      if (!decision) return;
      
      editingDecisionId = id;
      
      // Update the form title
      document.getElementById('form-title').textContent = 'Edit Decision';
      
      document.getElementById('title').value = decision.title;
      document.getElementById('context').value = decision.context;
      document.getElementById('rationale').value = decision.rationale;
      document.getElementById('status').value = decision.status;
      
      // Set selected node info
      selectedNodeId = decision.nodeId || null;
      selectedNodeName = decision.nodeName || null;
      selectedPageName = decision.pageName || null;
      
      // Update the node info display in the form
      const noSelectionElement = document.getElementById('no-selection');
      const nodeSelectionElement = document.getElementById('node-selection');
      
      if (selectedNodeId && selectedNodeName) {
        noSelectionElement.style.display = 'none';
        nodeSelectionElement.style.display = 'block';
        document.getElementById('node-name').textContent = selectedNodeName;
        document.getElementById('node-page').textContent = selectedPageName || '';
      } else {
        noSelectionElement.style.display = 'block';
        nodeSelectionElement.style.display = 'none';
      }
      
      // Clear existing fields
      document.getElementById('links-container').innerHTML = '';
      document.getElementById('pros-container').innerHTML = '';
      document.getElementById('cons-container').innerHTML = '';
      currentTags = [];
      
      // Add links
      if (decision.links && decision.links.length > 0) {
        decision.links.forEach(link => {
          const container = document.getElementById('links-container');
          const linkItem = document.createElement('div');
          linkItem.classList.add('link-item');
          linkItem.innerHTML = `
            <input type="text" placeholder="Title" class="link-title" value="${link.title}">
            <input type="text" placeholder="URL" class="link-url" value="${link.url}">
            <button type="button" class="button secondary remove-link">âœ•</button>
          `;
          container.appendChild(linkItem);
          
          // Add event listener to the remove button
          linkItem.querySelector('.remove-link').addEventListener('click', () => {
            container.removeChild(linkItem);
          });
        });
      } else {
        // Add an empty link field
        addLinkField();
      }
      
      // Add pros
      if (decision.pros && decision.pros.length > 0) {
        decision.pros.forEach(pro => {
          const container = document.getElementById('pros-container');
          const listItem = document.createElement('div');
          listItem.classList.add('list-item');
          listItem.innerHTML = `
            <input type="text" class="pro-item" value="${pro}">
            <button type="button" class="button secondary remove-item">âœ•</button>
          `;
          container.appendChild(listItem);
          
          // Add event listener to the remove button
          listItem.querySelector('.remove-item').addEventListener('click', () => {
            container.removeChild(listItem);
          });
        });
      } else {
        // Add an empty pro field
        addListItem('pros-container', 'pro-item');
      }
      
      // Add cons
      if (decision.cons && decision.cons.length > 0) {
        decision.cons.forEach(con => {
          const container = document.getElementById('cons-container');
          const listItem = document.createElement('div');
          listItem.classList.add('list-item');
          listItem.innerHTML = `
            <input type="text" class="con-item" value="${con}">
            <button type="button" class="button secondary remove-item">âœ•</button>
          `;
          container.appendChild(listItem);
          
          // Add event listener to the remove button
          listItem.querySelector('.remove-item').addEventListener('click', () => {
            container.removeChild(listItem);
          });
        });
      } else {
        // Add an empty con field
        addListItem('cons-container', 'con-item');
      }
      
      // Add tags
      if (decision.tags && decision.tags.length > 0) {
        currentTags = [...decision.tags];
        renderTags();
      }
      
      // Change button text and switch to new decision tab
      document.getElementById('save-decision').textContent = 'Update Decision';
      document.getElementById('decision-form-panel').classList.add('active');
      
      // Hide the "New Decision" button when editing a decision
      document.getElementById('new-decision-btn').style.display = 'none';
    }
    
    function deleteDecision(id) {
      // Delete the decision
      parent.postMessage({
        pluginMessage: {
          type: 'delete-decision',
          id
        }
      }, '*');
    }
    
    // Populate the tag filter dropdown
    function populateTagFilter() {
      const dropdown = document.getElementById('filter-tags');
      dropdown.innerHTML = '<option value="">All tags</option>';
      
      // Also update all unique tags for autocomplete
      allUniqueTags = new Set();
      
      decisions.forEach(decision => {
        if (decision.tags) {
          decision.tags.forEach(tag => allUniqueTags.add(tag));
        }
      });
      
      Array.from(allUniqueTags).sort().forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        dropdown.appendChild(option);
      });
    }
    
    // Handle tag input - updating with autocomplete feature
    document.getElementById('tag-input').addEventListener('input', showTagSuggestions);
    document.getElementById('tag-input').addEventListener('keydown', handleTagInputKeydown);
    document.getElementById('tag-input').addEventListener('blur', hideTagSuggestions);
    
    // Show tag suggestions based on current input
    function showTagSuggestions(e) {
      const input = e.target;
      const tagText = input.value.trim();
      
      if (tagText.length === 0) {
        hideTagSuggestions();
        return;
      }
      
      // Filter tags that match the input
      currentTagSuggestions = Array.from(allUniqueTags)
        .filter(tag => 
          tag.toLowerCase().includes(tagText.toLowerCase()) && 
          !currentTags.includes(tag)
        )
        .sort();
      
      const suggestionsContainer = document.getElementById('tag-suggestions');
      suggestionsContainer.innerHTML = '';
      
      if (currentTagSuggestions.length > 0) {
        currentTagSuggestions.forEach((tag, index) => {
          const suggestionElement = document.createElement('div');
          suggestionElement.classList.add('tag-suggestion');
          suggestionElement.textContent = tag;
          suggestionElement.addEventListener('mousedown', (e) => {
            // Using mousedown instead of click to prevent blur from firing first
            e.preventDefault();
            selectTagSuggestion(tag);
          });
          suggestionsContainer.appendChild(suggestionElement);
        });
        
        suggestionsContainer.classList.add('visible');
        highlightedSuggestionIndex = -1; // Reset highlighted suggestion
      } else {
        suggestionsContainer.classList.remove('visible');
      }
    }
    
    // Handle keyboard navigation in tag suggestions
    function handleTagInputKeydown(e) {
      const suggestionsContainer = document.getElementById('tag-suggestions');
      const suggestions = suggestionsContainer.querySelectorAll('.tag-suggestion');
      
      if (suggestions.length === 0) {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const input = document.getElementById('tag-input');
          const tagText = input.value.trim();
          
          if (tagText && !currentTags.includes(tagText)) {
            addTag(tagText);
            input.value = '';
          }
        }
        return;
      }
      
      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          highlightedSuggestionIndex = (highlightedSuggestionIndex + 1) % suggestions.length;
          updateHighlightedSuggestion();
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          highlightedSuggestionIndex = (highlightedSuggestionIndex - 1 + suggestions.length) % suggestions.length;
          updateHighlightedSuggestion();
          break;
          
        case 'Enter':
        case 'Tab':
          if (highlightedSuggestionIndex >= 0) {
            e.preventDefault();
            selectTagSuggestion(currentTagSuggestions[highlightedSuggestionIndex]);
          } else if (e.key === 'Enter') {
            e.preventDefault();
            const input = document.getElementById('tag-input');
            const tagText = input.value.trim();
            
            if (tagText && !currentTags.includes(tagText)) {
              addTag(tagText);
              input.value = '';
              hideTagSuggestions();
            }
          }
          break;
          
        case ',':
          e.preventDefault();
          const input = document.getElementById('tag-input');
          const tagText = input.value.trim();
          
          if (tagText && !currentTags.includes(tagText)) {
            addTag(tagText);
            input.value = '';
            hideTagSuggestions();
          }
          break;
          
        case 'Escape':
          e.preventDefault();
          hideTagSuggestions();
          break;
      }
    }
    
    // Update which suggestion is highlighted
    function updateHighlightedSuggestion() {
      const suggestions = document.querySelectorAll('.tag-suggestion');
      
      suggestions.forEach((suggestion, index) => {
        if (index === highlightedSuggestionIndex) {
          suggestion.classList.add('highlighted');
        } else {
          suggestion.classList.remove('highlighted');
        }
      });
    }
    
    // Select a tag suggestion and add it
    function selectTagSuggestion(tag) {
      if (tag && !currentTags.includes(tag)) {
        addTag(tag);
        document.getElementById('tag-input').value = '';
        hideTagSuggestions();
        document.getElementById('tag-input').focus(); // Keep focus on the input
      }
    }
    
    // Hide the tag suggestions dropdown
    function hideTagSuggestions() {
      setTimeout(() => {
        document.getElementById('tag-suggestions').classList.remove('visible');
      }, 100); // Small delay to allow for click to register on suggestion
    }
    
    // Message handler from the plugin code
    onmessage = (event) => {
      const message = event.data.pluginMessage;
      
      if (!message) return;
      
      switch (message.type) {
        case 'load-decisions':
          decisions = message.decisions || [];
          renderDecisionsList();
          populateTagFilter(); // This now also extracts all unique tags for autocomplete
          break;
          
        case 'selection-info':
          // Update the UI to show the currently selected node
          selectedNodeId = message.nodeId;
          selectedNodeName = message.nodeName;
          selectedPageName = message.pageName;
          
          const noSelectionElement = document.getElementById('no-selection');
          const nodeSelectionElement = document.getElementById('node-selection');
          
          if (selectedNodeId && selectedNodeName) {
            // Show the selected node info
            noSelectionElement.style.display = 'none';
            nodeSelectionElement.style.display = 'block';
            document.getElementById('node-name').textContent = selectedNodeName;
            document.getElementById('node-page').textContent = selectedPageName || '';
          } else {
            // Show the "no selection" message
            noSelectionElement.style.display = 'block';
            nodeSelectionElement.style.display = 'none';
          }
          break;          case 'decision-created':
          decisions.push(message.decision);
          // Reset form
          resetForm();
          // Hide form panel and update the list
          document.getElementById('decision-form-panel').classList.remove('active');
          // Make sure the New Decision button is visible
          document.getElementById('new-decision-btn').style.display = 'flex';
          renderDecisionsList();
          populateTagFilter(); // This also updates tag suggestions
          break;          case 'decision-updated':
          const index = decisions.findIndex(d => d.id === message.decision.id);
          if (index !== -1) {
            decisions[index] = message.decision;
            
            // If the detail panel is showing this decision, update it
            if (currentDetailDecisionId === message.decision.id) {
              viewDecisionDetails(message.decision.id);
            }
          }
          // Reset edit mode
          editingDecisionId = null;
          document.getElementById('save-decision').textContent = 'Save Decision';
          // Hide form panel and update the list
          document.getElementById('decision-form-panel').classList.remove('active');
          // Make sure the New Decision button is visible
          document.getElementById('new-decision-btn').style.display = 'flex';
          renderDecisionsList();
          populateTagFilter(); // This also updates tag suggestions
          break;
          
        case 'decision-deleted':
          decisions = decisions.filter(d => d.id !== message.id);
          
          // If the detail panel is showing this decision, close it
          if (currentDetailDecisionId === message.id) {
            document.getElementById('decision-detail-panel').classList.remove('active');
            currentDetailDecisionId = null;
          }
          
          renderDecisionsList();
          populateTagFilter(); // This also updates tag suggestions
          break;
          
        case 'user-info':
          currentUser = {
            name: message.name,
            id: message.id
          };
          break;
      }
    };
    
    // Initialize
    addLinkField();
    addListItem('pros-container', 'pro-item');
    addListItem('cons-container', 'con-item');
    
    // Make sure the New Decision button is initially visible
    document.getElementById('new-decision-btn').style.display = 'flex';
    
    // Tag suggestions logic
    document.getElementById('tag-input').addEventListener('input', (e) => {
      const value = e.target.value.trim();
      
      if (value === '') {
        // Hide suggestions when input is empty
        document.getElementById('tag-suggestions').classList.remove('visible');
        currentTagSuggestions = [];
        return;
      }
      
      // Filter suggestions based on input
      currentTagSuggestions = Array.from(allUniqueTags).filter(tag => 
        tag.toLowerCase().includes(value.toLowerCase())
      );
      
      // Show suggestions dropdown
      const suggestionsContainer = document.getElementById('tag-suggestions');
      suggestionsContainer.innerHTML = '';
      
      currentTagSuggestions.forEach((tag, index) => {
        const div = document.createElement('div');
        div.classList.add('tag-suggestion');
        div.textContent = tag;
        
        // Highlight suggestion on hover
        div.addEventListener('mouseenter', () => {
          highlightedSuggestionIndex = index;
          updateTagSuggestionHighlight();
        });
        
        // Select suggestion on click
        div.addEventListener('click', () => {
          addTag(tag);
          document.getElementById('tag-input').value = '';
          suggestionsContainer.classList.remove('visible');
        });
        
        suggestionsContainer.appendChild(div);
      });
      
      // Show the suggestions container
      suggestionsContainer.classList.add('visible');
      
      // Update highlight on arrow key navigation
      document.getElementById('tag-input').addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          highlightedSuggestionIndex = Math.min(highlightedSuggestionIndex + 1, currentTagSuggestions.length - 1);
          updateTagSuggestionHighlight();
          e.preventDefault();
        } else if (e.key === 'ArrowUp') {
          highlightedSuggestionIndex = Math.max(highlightedSuggestionIndex - 1, 0);
          updateTagSuggestionHighlight();
          e.preventDefault();
        } else if (e.key === 'Enter') {
          // Select highlighted suggestion on Enter
          if (highlightedSuggestionIndex >= 0 && highlightedSuggestionIndex < currentTagSuggestions.length) {
            const tag = currentTagSuggestions[highlightedSuggestionIndex];
            addTag(tag);
            document.getElementById('tag-input').value = '';
            document.getElementById('tag-suggestions').classList.remove('visible');
          }
        }
      });
    });
    
    function updateTagSuggestionHighlight() {
      const suggestions = document.querySelectorAll('.tag-suggestion');
      suggestions.forEach((s, index) => {
        if (index === highlightedSuggestionIndex) {
          s.classList.add('highlighted');
        } else {
          s.classList.remove('highlighted');
        }
      });
    }
  </script>
</body>
</html>
