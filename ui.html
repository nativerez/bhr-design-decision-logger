<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    body {
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      background: #fff;
      padding: 16px;
      overflow-x: hidden;
    }
    
    body.modal-open {
      overflow: hidden;
    }
    h2 {
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 20px;
    }
    h3 {
      margin-bottom: 16px;
      font-weight: 500;
      font-size: 16px;
    }
    .tab-container {
      display: flex;
      border-bottom: 1px solid #e5e5e5;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 500;
      font-size: 15px;
      color: #333;
    }
    .tab.active {
      border-bottom: 2px solid #18a0fb;
      color: #18a0fb;
    }
    /* Tab content visibility control */
    .tab-content {
      display: none !important; /* Use !important to override any other styles */
    }
    .tab-content.active {
      display: block !important; /* Use !important to override any other styles */
    }
    
    /* Export buttons styling */
    .export-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
      gap: 8px;
    }
    
    .export-actions .button {
      display: flex;
      align-items: center;
      font-size: 13px;
    }
    
    .export-actions .button:hover {
      background-color: #f0f0f0;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 14px;
    }
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-size: 14px;
    }
    textarea {
      height: 100px;
      resize: vertical;
    }
    .link-item {
      display: flex;
      margin-bottom: 10px;
    }
    .link-item input {
      flex: 1;
      margin-right: 10px;
    }
    .link-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
    }
    .pros-cons {
      display: flex;
      gap: 16px;
    }
    .pros, .cons {
      flex: 1;
    }
    .list-item {
      display: flex;
      margin-bottom: 8px;
    }
    .list-item input {
      flex: 1;
      margin-right: 10px;
    }
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .tag {
      background: #f0f0f0;
      padding: 6px 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      font-size: 13px;
    }
    .tag span {
      margin-right: 6px;
    }
    .tag button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }
    
    /* Tag suggestions dropdown */
    .tag-suggestions {
      position: absolute;
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 150px;
      overflow-y: auto;
      width: calc(100% - 40px);
      z-index: 100;
      display: none;
    }
    
    .tag-suggestions.visible {
      display: block;
    }
    
    .tag-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .tag-suggestion:hover {
      background-color: #f5f5f5;
    }
    
    /* Highlighted suggestion */
    .tag-suggestion.highlighted {
      background-color: #e9f5ff;
    }
    
    .button {
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }
    .button.secondary {
      background: #f5f5f5;
      color: #333;
      border: 1px solid #e5e5e5;
    }
    .button.danger {
      background: transparent;
      color: #ff5252
    }
    .decision-list {
      margin-top: 16px;
    }
    .decision-card {
      padding: 16px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      margin-bottom: 16px;
      background-color: #fff !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: relative;
      transition: all 0.2s ease;
      border-left-width: 4px;
    }
    
    .decision-card:hover {
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
      border-top-color: #d0d0d0;
      border-right-color: #d0d0d0;
      border-bottom-color: #d0d0d0;
      /* Left border color preserved for status */
    }
    
    /* Enhanced styling for better clickable affordance */
    .decision-card {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    /* Status border colors for decision cards */
    .decision-card.status-proposed {
      border-left-color: #0D47A1; /* Blue for proposed */
    }
    .decision-card.status-accepted {
      border-left-color: #1B5E20; /* Green for accepted */
    }
    .decision-card.status-rejected {
      border-left-color: #B71C1C; /* Red for rejected */
    }
    .decision-card.status-deprecated {
      border-left-color: #3E2723; /* Brown for deprecated */
    }
    .decision-card.status-superseded {
      border-left-color: #4A148C; /* Purple for superseded */
    }
    
    .figma-node-link .tag:hover {
      background-color: #D4EDFF !important;
    }

    .figma-node-info {
      margin-bottom: 20px;
    }
    .decision-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .decision-title {
      font-weight: 600;
      font-size: 16px;
      padding-right: 75px; /* Make room for the status badge */
      color: #000;
    }
    .decision-meta {
      font-size: 12px;
      color: #888;
      margin-bottom: 10px;
    }
    .decision-context {
      font-size: 14px;
      margin-bottom: 10px;
      color: #000;
    }
    .decision-actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
    }
    .section {
      margin-bottom: 20px;
      padding: 16px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      margin-bottom: 16px;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      position: relative;
      transition: all 0.2s ease;
    }
    .filter-bar {
      display: flex;
      margin-bottom: 16px;
      gap: 10px;
    }
    .filter-bar input, 
    .filter-bar select {
      flex: 1;
      min-width: 0; /* Prevents flex items from overflowing */
      font-size: 14px;
    }
    
    /* New styles for detail panel */
    .decision-detail-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 10;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    
    .decision-detail-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px 20px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .decision-detail-panel.active {
      right: 0;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 20px 12px 20px;
      border-bottom: 1px solid #eee;
      background-color: white;
      flex-shrink: 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      z-index: 3; /* Increased z-index to be higher than form-actions */
    }
    .detail-title {
      font-weight: 600;
      font-size: 20px;
      color: #333;
      flex: 1;
    }
    .detail-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      margin-left: 10px;
    }
    .detail-header .status-badge {
      position: static;
      margin-left: 10px;
      margin-right: 10px;
    }
    .detail-section {
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #f5f5f5;
    }
    .detail-section-title {
      font-weight: 500;
      margin-bottom: 10px;
      font-size: 16px;
      color: #555;
      padding-bottom: 5px;
    }
    .detail-section-content {
      margin-bottom: 20px;
      line-height: 1.6;
      font-size: 14px;
    }
    .detail-meta {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #888;
    }
    .detail-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .detail-link {
      display: block;
      color: #18a0fb;
      text-decoration: none;
      font-size: 14px;
    }
    .detail-pros-cons {
      display: flex;
      gap: 16px;
      margin-top: 10px;
    }
    .detail-pros, .detail-cons {
      flex: 1;
      padding: 12px;
      border-radius: 4px;
    }
    .detail-pros {
      background-color: #f2fbf2;
    }
    .detail-cons {
      background-color: #fff0f0;
    }
    .detail-list-title {
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .detail-list {
      list-style-position: inside;
      padding-left: 6px;
      font-size: 14px;
    }
    .detail-list li {
      margin-bottom: 6px;
    }
    .detail-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
      justify-content: flex-end;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .status-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    .status-proposed {
      background-color: #E3F2FD;
      color: #0D47A1;
    }
    .status-accepted {
      background-color: #E8F5E9;
      color: #1B5E20;
    }
    .status-rejected {
      background-color: #FFEBEE;
      color: #B71C1C;
    }
    .status-deprecated {
      background-color: #EFEBE9;
      color: #3E2723;
    }
    .status-superseded {
      background-color: #F3E5F5;
      color: #4A148C;
    }
    
    /* New action button style */
    .action-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: #18a0fb;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 100;
      transition: all 0.2s ease;
      font-size: 24px;
      border: none;
    }
    
    .action-button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* Decision form panel style */
    .decision-form-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      z-index: 10;
      background-color: #fff;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Prevents double scrollbars */
    }
    
    .decision-form-panel.active {
      right: 0;
    }
    
    .decision-form-panel form {
      flex: 1;
      overflow-y: auto;
      padding: 20px 20px 0 20px;
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
      min-height: calc(100% - 60px); /* Ensures form takes up full height minus header */
    }
    
    .decision-form-panel form .section:last-of-type {
      margin-bottom: 80px; /* Provide extra space at bottom to prevent content from being hidden behind fixed buttons */
      padding-bottom: 20px;
    }
    
    
    .decision-form-panel form .form-group {
      padding-bottom: 5px;
    }
    
    .form-actions {
      padding: 15px 20px;
      background-color: white;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-shrink: 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
      position: sticky;
      bottom: 0;
      right: 0;
      left: 0;
      z-index: 2;
      width: 100%;
      box-sizing: border-box;
      margin-top: auto;
    }
    .content-main {
      position: relative;
      width: 100%;
    }
  </style>
</head>
<body>

  <!-- Tab Navigation -->
  <div class="tab-container">
    <div class="tab active" data-tab="decisions">Decisions</div>
    <div class="tab" data-tab="resources">Resources</div>
  </div>

  <!-- Decision History -->
  <div id="content-decisions" class="content-main tab-content active">
    <div class="filter-bar">
      <input type="text" id="search-input" placeholder="Search decisions...">
      <select id="filter-tags">
        <option value="">All tags</option>
      </select>
      <select id="filter-status">
        <option value="">All statuses</option>
        <option value="proposed">Proposed</option>
        <option value="accepted">Accepted</option>
        <option value="rejected">Rejected</option>
        <option value="deprecated">Deprecated</option>
        <option value="superseded">Superseded</option>
      </select>
      <select id="sort-decisions">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="az">A-Z</option>
        <option value="za">Z-A</option>
      </select>
    </div>      <div class="export-actions" style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
      <button id="copy-markdown-btn" class="button secondary" title="Copy all decisions as markdown to clipboard">Copy as Markdown</button>
      <button id="download-markdown-btn" class="button secondary" style="margin-left: 8px;" title="Download all decisions as markdown file">Download as Markdown</button>
    </div>
    <div class="decision-list" id="decision-list">
      <!-- Decision cards will be inserted here -->
      <div class="empty-state">No decisions recorded yet.</div>
    </div>
  </div>

  <!-- Resources Tab Content -->
  <div id="content-resources" class="content-main tab-content">
    <div class="filter-bar">
      <input type="text" id="resource-search-input" placeholder="Search resources...">
      <select id="resource-category-filter">
        <option value="">All categories</option>
        <option value="documentation">Documentation</option>
        <option value="guidelines">Guidelines</option>
        <option value="research">Research</option>
        <option value="reference">Reference</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="resource-list" id="resource-list">
      <!-- Resource cards will be inserted here -->
      <div class="empty-state">No resources added yet.</div>
    </div>
  </div>

  <!-- Action Buttons -->
  <button id="new-decision-btn" class="action-button">+</button>
  <button id="new-resource-btn" class="action-button" style="display: none;">+</button>

  <!-- Decision Form Panel (initially hidden) -->
  <div id="decision-form-panel" class="decision-form-panel">
    <div class="detail-header">
      <div class="detail-title" id="form-title">New Decision</div>
      <button class="detail-close" id="form-close">✕</button>
    </div>
    
    <form id="decision-form">
      <!-- Figma Element Section -->
      
      <h3>Linked Figma Element</h3>
      <div id="figma-node-info" class="figma-node-info">
        <div id="no-selection" style="color: #888; font-style: italic;">No element selected. Select a Figma element before creating a decision to link it.</div>
        <div id="node-selection" style="display: none;">
          <div class="tag" style="background-color: #E9F5FF; color: #007ACC;">
            <span id="node-page" style="color: #888; margin-right: 5px; font-size: 11px;"></span>
            <span id="node-name">Element name</span>
          </div>
        </div>
      </div>
      
      
      <div class="section">
        <div class="form-group">
          <label for="title">Decision Title</label>
          <input type="text" id="title" placeholder="What is the decision about?" required>
        </div>
        <div class="form-group">
          <label for="context">Decision Details</label>
          <textarea id="context" placeholder="Describe the details of this decision" required></textarea>
        </div>
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" required>
            <option value="proposed">Proposed</option>
            <option value="accepted">Accepted</option>
            <option value="rejected">Rejected</option>
            <option value="deprecated">Deprecated</option>
            <option value="superseded">Superseded</option>
          </select>
        </div>
        <div class="form-group">
          <label for="rationale">Rationale</label>
          <textarea id="rationale" placeholder="Why was this decision made?" required></textarea>
        </div>
      </div>
      
      <!-- Links Section -->
      <div class="section">
        <h3>Links & References <span style="color: #888; font-size: 12px; font-weight: normal;">(Optional)</span></h3>
        <div id="links-container">
          <div class="link-item">
            <input type="text" placeholder="Title" class="link-title">
            <input type="text" placeholder="URL" class="link-url">
            <button type="button" class="button secondary remove-link">✕</button>
          </div>
        </div>
        <button type="button" id="add-link" class="button secondary">Add Link</button>
      </div>
      
      <!-- Pros & Cons Section -->
      <div class="section">
        <h3>Pros & Cons <span style="color: #888; font-size: 12px; font-weight: normal;">(Optional)</span></h3>
        <div class="pros-cons">
          <div class="pros">
            <label>Pros</label>
            <div id="pros-container">
              <div class="list-item">
                <input type="text" class="pro-item" placeholder="Add a pro">
                <button type="button" class="button secondary remove-item">✕</button>
              </div>
            </div>
            <button type="button" id="add-pro" class="button secondary">Add Pro</button>
          </div>
          <div class="cons">
            <label>Cons</label>
            <div id="cons-container">
              <div class="list-item">
                <input type="text" class="con-item" placeholder="Add a con">
                <button type="button" class="button secondary remove-item">✕</button>
              </div>
            </div>
            <button type="button" id="add-con" class="button secondary">Add Con</button>
          </div>
        </div>
      </div>
      
      <!-- Tags Section -->
      <div class="section">
        <h3>Tags <span style="color: #888; font-size: 12px; font-weight: normal;">(Optional)</span></h3>
        <div style="position: relative;">
          <input type="text" id="tag-input" placeholder="Add tags (comma separated)">
          <div id="tag-suggestions" class="tag-suggestions"></div>
        </div>
        <div class="tags-container" id="tags-container">
          <!-- Tags will be inserted here -->
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" id="cancel" class="button secondary">Cancel</button>
        <button type="submit" id="save-decision" class="button">Save Decision</button>
      </div>
    </form>
  </div>

  <!-- Edit Decision Modal (hidden by default) -->
  <div id="edit-modal" style="display: none;">
    <!-- Edit form will be similar to new decision form -->
  </div>
  
  <!-- Resource Form Panel (initially hidden) -->
  <div id="resource-form-panel" class="decision-form-panel">
    <div class="detail-header">
      <div class="detail-title" id="resource-form-title">New Resource</div>
      <button class="detail-close" id="resource-form-close">✕</button>
    </div>
    
    <form id="resource-form">
      <div class="section">
        <div class="form-group">
          <label for="resource-title">Resource Title</label>
          <input type="text" id="resource-title" placeholder="Title of the resource" required>
        </div>
        
        <div class="form-group">
          <label for="resource-description">Description</label>
          <textarea id="resource-description" placeholder="Describe this resource" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="resource-url">URL</label>
          <input type="text" id="resource-url" placeholder="https://..." required>
        </div>
        
        <div class="form-group">
          <label for="resource-category">Category</label>
          <select id="resource-category" required>
            <option value="documentation">Documentation</option>
            <option value="guidelines">Guidelines</option>
            <option value="research">Research</option>
            <option value="reference">Reference</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      
      <!-- Tags Section -->
      <div class="section">
        <h3>Tags <span style="color: #888; font-size: 12px; font-weight: normal;">(Optional)</span></h3>
        <div style="position: relative;">
          <input type="text" id="resource-tag-input" placeholder="Add tags (comma separated)">
          <div id="resource-tag-suggestions" class="tag-suggestions"></div>
        </div>
        <div class="tags-container" id="resource-tags-container">
          <!-- Tags will be inserted here -->
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" id="cancel-resource" class="button secondary">Cancel</button>
        <button type="submit" id="save-resource" class="button">Save Resource</button>
      </div>
    </form>
  </div>
  
  <!-- Resource Detail Panel (hidden by default) -->
  <div id="resource-detail-panel" class="decision-detail-panel">
    <div class="detail-header">
      <div class="detail-title" id="resource-detail-title">Resource Title</div>
      <div class="tag resource-category-tag" id="resource-detail-category">Category</div>
      <button class="detail-close" id="resource-detail-close">✕</button>
    </div>
    
    <div class="decision-detail-panel-content">
      <div class="detail-meta">
        <div id="resource-detail-author">By Author</div>
        <div id="resource-detail-date">On Date</div>
      </div>
    
    <div class="detail-section">
      <div class="detail-section-title">Description</div>
      <div class="detail-section-content" id="resource-detail-description">Description will go here</div>
    </div>
    
    <div class="detail-section">
      <div class="detail-section-title">Link</div>
      <div class="detail-links">
        <a href="#" target="_blank" class="detail-link" id="resource-detail-link">Resource URL</a>
      </div>
    </div>
    
    <div id="resource-detail-tags-section" class="detail-section" style="display: none;">
      <div class="detail-section-title">Tags</div>
      <div class="tags-container" id="resource-detail-tags">
        <!-- Tags will be inserted here -->
      </div>
    </div>
    
    <div class="detail-actions">
      <button class="button secondary" id="resource-detail-visit-button">Visit Resource</button>
      <button class="button secondary" id="resource-detail-edit-button">Edit</button>
      <button class="button secondary danger" id="resource-detail-delete-button">Delete</button>
    </div>
    </div> <!-- end of decision-detail-panel-content -->
  </div>

  <!-- Decision Detail Panel (hidden by default) -->
  <div id="decision-detail-panel" class="decision-detail-panel">
    <div class="detail-header">
      <div class="detail-title" id="detail-title">Decision Title</div>
      <div class="status-badge" id="detail-status">Status</div>
      <button class="detail-close" id="detail-close">✕</button>
    </div>
    
    <div class="decision-detail-panel-content">
      <div class="detail-meta">
        <div id="detail-author">By Author</div>
        <div id="detail-date">On Date</div>
      </div>
    
    <div class="detail-section">
      <div class="detail-section-title">Decision Details</div>
      <div class="detail-section-content" id="detail-context">Decision details will go here</div>
    </div>
    
    <div class="detail-section">
      <div class="detail-section-title">Rationale</div>
      <div class="detail-section-content" id="detail-rationale">Rationale content will go here</div>
    </div>
    
    <div id="detail-links-section" class="detail-section" style="display: none;">
      <div class="detail-section-title">Links & References</div>
      <div class="detail-links" id="detail-links">
        <!-- Links will be inserted here -->
      </div>
    </div>
    
    <div id="detail-pros-cons-section" class="detail-section" style="display: none;">
      <div class="detail-section-title">Pros & Cons</div>
      <div class="detail-pros-cons">
        <div class="detail-pros">
          <div class="detail-list-title">Pros</div>
          <ul class="detail-list" id="detail-pros">
            <!-- Pros will be inserted here -->
          </ul>
        </div>
        <div class="detail-cons">
          <div class="detail-list-title">Cons</div>
          <ul class="detail-list" id="detail-cons">
            <!-- Cons will be inserted here -->
          </ul>
        </div>
      </div>
    </div>
    
    <div id="detail-tags-section" class="detail-section" style="display: none;">
      <div class="detail-section-title">Tags</div>
      <div class="tags-container" id="detail-tags">
        <!-- Tags will be inserted here -->
      </div>
    </div>
    
    <div id="detail-node-section" class="detail-section" style="display: none;">
      <div class="detail-section-title">Linked Figma Element</div>
      <div id="detail-node-info">
        <!-- Node info will be inserted here -->
      </div>
      <div style="margin-top: 10px;">
        <button id="detail-navigate-button" class="button secondary">Navigate to Element</button>
      </div>
    </div>
    
    <div class="detail-actions">
      <button class="button secondary" id="detail-edit-button">Edit Decision</button>
      <button class="button secondary danger" id="detail-delete-button">Delete</button>
    </div>
    </div> <!-- end of decision-detail-panel-content -->
  </div>

  <script>
    // Global variables
    let decisions = [];
    let resources = []; // Array to store all resources
    let currentUser = null;
    let editingDecisionId = null;
    let editingResourceId = null;
    let currentTags = [];
    let currentResourceTags = []; // Tags for the current resource being edited
    let selectedNodeId = null;
    let selectedNodeName = null;
    let selectedPageName = null;
    let currentDetailDecisionId = null;
    let currentDetailResourceId = null;
    let allUniqueTags = new Set(); // Store all unique tags for autocomplete
    let currentTagSuggestions = []; // Current suggestions based on user input
    let highlightedSuggestionIndex = -1; // Currently highlighted suggestion
    let activeTab = 'decisions'; // Track which tab is currently active
    let currentDocumentId = null; // Store the current document ID for deep links
    let currentFileName = 'Untitled'; // Store the current file name for URLs
    
    // Function to request the document ID from the plugin
    function requestDocumentId() {
      console.log('Requesting document ID from plugin');
      parent.postMessage({ pluginMessage: { type: 'get-document-id' } }, '*');
    }
    
    // Manually force a known document ID (for testing)
    function forceDocumentId(id) {
      currentDocumentId = id;
      console.log('🔧 Manually forced document ID to:', currentDocumentId);
      return currentDocumentId;
    }
    
    // Set file name (used by the URL formatter)
    function setFileName(fileName) {
      currentFileName = fileName || 'Untitled';
      console.log('File name set to:', currentFileName);
      return currentFileName;
    }
    
    // Debug utility function to check document ID and decisions state
    function debugState() {
      console.group('🔍 Debug State');
      console.log('Current document ID:', currentDocumentId);
      console.log('Current file name:', currentFileName);
      console.log('Has decisions:', decisions.length > 0);
      if (decisions.length > 0) {
        console.log('First decision:', {
          id: decisions[0].id,
          title: decisions[0].title,
          nodeId: decisions[0].nodeId,
          nodeName: decisions[0].nodeName
        });
        
        // Check if at least one decision has a nodeId
        const hasNodeIds = decisions.some(d => d.nodeId);
        console.log('At least one decision has nodeId:', hasNodeIds);
        
        if (hasNodeIds) {
          // Show first decision with a nodeId
          const decisionWithNodeId = decisions.find(d => d.nodeId);
          if (decisionWithNodeId) {
            console.log('Example decision with nodeId:', {
              id: decisionWithNodeId.id,
              title: decisionWithNodeId.title,
              nodeId: decisionWithNodeId.nodeId,
              nodeName: decisionWithNodeId.nodeName
            });
          }
        }
      }
      console.groupEnd();
    }
    
    // Convert decisions to markdown format
    function convertDecisionsToMarkdown(decisionsToConvert = decisions) {
      let markdown = `# Design Decisions\n\n`;
      
      // Add timestamp for when the export was created
      const exportDate = new Date().toLocaleString();
      markdown += `*Exported on: ${exportDate}*\n\n`;
      
      // Run debug state check
      debugState();
      
      // Debug information about document ID
      console.log('Document ID when generating markdown:', currentDocumentId);
      
      // Sort decisions by newest first by default
      const sortedDecisions = [...decisionsToConvert].sort((a, b) => b.timestamp - a.timestamp);
      
      sortedDecisions.forEach((decision, index) => {
        // Format the decision date
        const decisionDate = new Date(decision.timestamp).toLocaleString();
        
        // Decision title with status
        markdown += `## ${decision.title} [${decision.status || 'Proposed'}]\n\n`;
        
        // Add Figma link on a separate line right after the title
        if (decision.nodeId && currentDocumentId) {
          // Format the file name for URL (encode spaces as dashes)
          const formattedFileName = currentFileName.replace(/\s+/g, '-');
          // Create a web-friendly link to the Figma element using the exact format
          const figmaWebLink = `https://www.figma.com/design/${currentDocumentId}/${formattedFileName}?node-id=${decision.nodeId}&t=KQ92N16ekTbaLvJw-1`;
          markdown += `[View in Figma](${figmaWebLink})\n\n`;
        }
        
        // Author and date
        markdown += `**Author:** ${decision.author}  \n`;
        markdown += `**Date:** ${decisionDate}  \n`;
        
        // Add linked Figma element if present
        if (decision.nodeId && decision.nodeName && currentDocumentId) {
          // Format the file name for URL (encode spaces as dashes)
          const formattedFileName = currentFileName.replace(/\s+/g, '-');
          // Create a web-friendly link to the Figma element using the exact format
          const figmaWebLink = `https://www.figma.com/design/${currentDocumentId}/${formattedFileName}?node-id=${decision.nodeId}&t=KQ92N16ekTbaLvJw-1`;
          markdown += `**Linked Element:** [${decision.nodeName}](${figmaWebLink})${decision.pageName ? ' (Page: ' + decision.pageName + ')' : ''}  \n`;
        }
        
        // Add tags if present
        if (decision.tags && decision.tags.length > 0) {
          markdown += `**Tags:** ${decision.tags.join(', ')}  \n`;
        }
        
        markdown += '\n';
        
        // Decision details
        markdown += `### Decision Details\n\n${decision.context}\n\n`;
        
        // Rationale
        markdown += `### Rationale\n\n${decision.rationale}\n\n`;
        
        // Links section
        if (decision.links && decision.links.length > 0) {
          markdown += `### Links & References\n\n`;
          decision.links.forEach(link => {
            // Ensure the URL is valid and properly formatted
            let url = link.url;
            
            // If URL is empty, # or undefined, use a placeholder
            if (!url || url === '#') {
              url = 'https://missing-url.com';
            }
            // If URL doesn't have protocol, add https://
            else if (!/^https?:\/\//i.test(url)) {
              url = 'https://' + url;
            }
            
            // Log the URL for debugging
            console.log(`Link URL for "${link.title}":`, url);
            
            markdown += `- [${link.title}](${url})\n`;
          });
          markdown += '\n';
        }
        
        // Pros & Cons section
        if ((decision.pros && decision.pros.length > 0) || (decision.cons && decision.cons.length > 0)) {
          markdown += `### Pros & Cons\n\n`;
          
          if (decision.pros && decision.pros.length > 0) {
            markdown += `#### Pros\n\n`;
            decision.pros.forEach(pro => {
              markdown += `- ${pro}\n`;
            });
            markdown += '\n';
          }
          
          if (decision.cons && decision.cons.length > 0) {
            markdown += `#### Cons\n\n`;
            decision.cons.forEach(con => {
              markdown += `- ${con}\n`;
            });
            markdown += '\n';
          }
        }
        
        // Add separator between decisions except for the last one
        if (index < sortedDecisions.length - 1) {
          markdown += `---\n\n`;
        }
      });
      
      return markdown;
    }
    
    // Copy markdown to clipboard
    function copyToClipboard(text) {
      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          navigator.clipboard.writeText(text)
            .then(() => {
              console.log('Copied to clipboard using Clipboard API');
              return true;
            })
            .catch(err => {
              console.error('Error using Clipboard API:', err);
              // Fall back to execCommand approach
              return legacyCopyToClipboard(text);
            });
          return true;
        } catch (err) {
          console.error('Error with Clipboard API:', err);
          // Fall back to execCommand approach
          return legacyCopyToClipboard(text);
        }
      } else {
        // Use legacy approach
        return legacyCopyToClipboard(text);
      }
    }
    
    // Legacy clipboard copy method
    function legacyCopyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';  // Avoid scrolling to bottom
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          console.log('Copied to clipboard using execCommand');
          return true;
        } else {
          console.error('Unable to copy to clipboard with execCommand');
          return false;
        }
      } catch (err) {
        console.error('Error copying to clipboard with execCommand:', err);
        return false;
      } finally {
        document.body.removeChild(textarea);
      }
    }
    
    // Download markdown as a file
    function downloadMarkdownFile(markdown) {
      const filename = `design-decisions-${new Date().toISOString().slice(0, 10)}.md`;
      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 100);
    }
    
    // Event listener for Copy as Markdown button
    document.getElementById('copy-markdown-btn').addEventListener('click', () => {
      // Get currently filtered decisions
      const searchText = document.getElementById('search-input').value.toLowerCase();
      const tagFilter = document.getElementById('filter-tags').value;
      const statusFilter = document.getElementById('filter-status').value;
      
      console.log('Copy as Markdown - Current document ID:', currentDocumentId);
      
      const filteredDecisions = decisions.filter(decision => {
        // Search text filter
        const matchesSearch = searchText === '' || 
          decision.title.toLowerCase().includes(searchText) || 
          decision.context.toLowerCase().includes(searchText) || 
          decision.rationale.toLowerCase().includes(searchText);
        
        // Tag filter
        const matchesTag = tagFilter === '' || 
          (decision.tags && decision.tags.includes(tagFilter));
        
        // Status filter
        const matchesStatus = statusFilter === '' || decision.status === statusFilter;
        
        return matchesSearch && matchesTag && matchesStatus;
      });
      
      // Log information about decisions being exported
      console.log('Copy as Markdown - Filtered decisions for export:', filteredDecisions.length);
      filteredDecisions.forEach((decision, index) => {
        console.log(`Decision ${index+1}:`, decision.title);
        console.log(`  Has nodeId:`, !!decision.nodeId);
        console.log(`  Has nodeName:`, !!decision.nodeName);
      });
      
      const markdown = convertDecisionsToMarkdown(filteredDecisions);
      if (copyToClipboard(markdown)) {
        alert('Decisions copied to clipboard as Markdown!');
      } else {
        alert('Failed to copy to clipboard. Your browser may not support this feature.');
      }
    });
    
    // Event listener for Download as Markdown button
    document.getElementById('download-markdown-btn').addEventListener('click', () => {
      // Get currently filtered decisions
      const searchText = document.getElementById('search-input').value.toLowerCase();
      const tagFilter = document.getElementById('filter-tags').value;
      const statusFilter = document.getElementById('filter-status').value;
      
      const filteredDecisions = decisions.filter(decision => {
        // Search text filter
        const matchesSearch = searchText === '' || 
          decision.title.toLowerCase().includes(searchText) || 
          decision.context.toLowerCase().includes(searchText) || 
          decision.rationale.toLowerCase().includes(searchText);
        
        // Tag filter
        const matchesTag = tagFilter === '' || 
          (decision.tags && decision.tags.includes(tagFilter));
        
        // Status filter
        const matchesStatus = statusFilter === '' || decision.status === statusFilter;
        
        return matchesSearch && matchesTag && matchesStatus;
      });
      
      const markdown = convertDecisionsToMarkdown(filteredDecisions);
      downloadMarkdownFile(markdown);
    });
    
    // Request the document ID automatically
    requestDocumentId();
    
    // Get current user info
    parent.postMessage({ pluginMessage: { type: 'get-user-info' } }, '*');
    
    // Request the document ID explicitly
    requestDocumentId();
    
    // Tab switching functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        switchTab(tabId);
      });
    });
    
    // Initialize the correct tab on page load
    switchTab(activeTab);
    
    function switchTab(tabId) {
      // Update active tab
      activeTab = tabId;
      
      // Update tab UI
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
      });
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
      
      // Update content visibility
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`content-${tabId}`).classList.add('active');
      
      // Update the action button visibility
      document.getElementById('new-decision-btn').style.display = (tabId === 'decisions') ? 'flex' : 'none';
      document.getElementById('new-resource-btn').style.display = (tabId === 'resources') ? 'flex' : 'none';
    }

    // New Decision Button - show the form panel
    document.getElementById('new-decision-btn').addEventListener('click', showDecisionForm);
    
    // New Resource Button - show the resource form panel
    document.getElementById('new-resource-btn').addEventListener('click', showResourceForm);
    
    // Close form panel
    document.getElementById('form-close').addEventListener('click', hideDecisionForm);
    
    function showDecisionForm() {
      // Reset the form first
      resetForm();
      // Set title to "New Decision" if not editing
      if (!editingDecisionId) {
        document.getElementById('form-title').textContent = 'New Decision';
      }
      // Reset scroll position to the top
      document.getElementById('decision-form').scrollTop = 0;
      // Show the form panel
      document.getElementById('decision-form-panel').classList.add('active');
      // Hide the "New Decision" button when form is shown
      document.getElementById('new-decision-btn').style.display = 'none';
      // Prevent body scrolling
      document.body.classList.add('modal-open');
    }
    
    function hideDecisionForm() {
      document.getElementById('decision-form-panel').classList.remove('active');
      // Reset the form when hiding
      resetForm();
      // Show the "New Decision" button when form is closed
      document.getElementById('new-decision-btn').style.display = 'flex';
      // Allow body scrolling
      document.body.classList.remove('modal-open');
    }
    
    function resetForm() {
      // Reset form and editing state
      document.getElementById('decision-form').reset();
      document.getElementById('links-container').innerHTML = '';
      document.getElementById('pros-container').innerHTML = '';
      document.getElementById('cons-container').innerHTML = '';
      currentTags = [];
      renderTags();
      editingDecisionId = null;
      document.getElementById('save-decision').textContent = 'Save Decision';
      
      // Add empty fields back
      addLinkField();
      addListItem('pros-container', 'pro-item');
      addListItem('cons-container', 'con-item');
    }

    // Handle form submission
    document.getElementById('decision-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const title = document.getElementById('title').value;
      const context = document.getElementById('context').value;
      const rationale = document.getElementById('rationale').value;
      const status = document.getElementById('status').value;
      
      // Gather links
      const links = [];
      document.querySelectorAll('.link-item').forEach(linkItem => {
        const titleInput = linkItem.querySelector('.link-title');
        const urlInput = linkItem.querySelector('.link-url');
        
        if (titleInput.value && urlInput.value) {
          links.push({
            title: titleInput.value,
            url: urlInput.value
          });
        }
      });
      
      // Gather pros
      const pros = [];
      document.querySelectorAll('.pro-item').forEach(input => {
        if (input.value) pros.push(input.value);
      });
      
      // Gather cons
      const cons = [];
      document.querySelectorAll('.con-item').forEach(input => {
        if (input.value) cons.push(input.value);
      });
      
      // Check if we're editing or creating
      if (editingDecisionId) {
        // Editing an existing decision
        parent.postMessage({
          pluginMessage: {
            type: 'edit-decision',
            decision: {
              id: editingDecisionId,
              title,
              context,
              rationale,
              links,
              pros,
              cons,
              tags: currentTags,
              nodeId: selectedNodeId,
              nodeName: selectedNodeName,
              pageName: selectedPageName,
              status // Include status when editing a decision
            }
          }
        }, '*');
      } else {
        // Creating a new decision
        parent.postMessage({
          pluginMessage: {
            type: 'create-decision',
            title,
            context,
            rationale,
            links,
            pros,
            cons,
            tags: currentTags,
            nodeId: selectedNodeId,
            nodeName: selectedNodeName,
            pageName: selectedPageName, // Include page name when creating a decision
            status // Include status when creating a decision
          }
        }, '*');
      }
      
      // Hide the form panel after submission
      document.getElementById('decision-form-panel').classList.remove('active');
      
      // Show the "New Decision" button again after submission
      document.getElementById('new-decision-btn').style.display = 'flex';
      
      // Allow body scrolling
      document.body.classList.remove('modal-open');
    });

    // Add new link input field
    document.getElementById('add-link').addEventListener('click', addLinkField);
    
    function addLinkField() {
      const container = document.getElementById('links-container');
      const linkItem = document.createElement('div');
      linkItem.classList.add('link-item');
      linkItem.innerHTML = `
        <input type="text" placeholder="Title" class="link-title">
        <input type="text" placeholder="URL" class="link-url">
        <button type="button" class="button secondary remove-link">✕</button>
      `;
      container.appendChild(linkItem);
      
      // Add event listener to the remove button
      linkItem.querySelector('.remove-link').addEventListener('click', () => {
        container.removeChild(linkItem);
      });
    }
    
    // Add event listeners for existing remove buttons
    document.querySelectorAll('.remove-link').forEach(button => {
      button.addEventListener('click', (e) => {
        const linkItem = e.target.closest('.link-item');
        linkItem.parentNode.removeChild(linkItem);
      });
    });
    
    // Add pro item
    document.getElementById('add-pro').addEventListener('click', () => {
      addListItem('pros-container', 'pro-item');
    });
    
    // Add con item
    document.getElementById('add-con').addEventListener('click', () => {
      addListItem('cons-container', 'con-item');
    });
    
    function addListItem(containerId, className) {
      const container = document.getElementById(containerId);
      const listItem = document.createElement('div');
      listItem.classList.add('list-item');
      listItem.innerHTML = `
        <input type="text" class="${className}" placeholder="Add an item">
        <button type="button" class="button secondary remove-item">✕</button>
      `;
      container.appendChild(listItem);
      
      // Add event listener to the remove button
      listItem.querySelector('.remove-item').addEventListener('click', () => {
        container.removeChild(listItem);
      });
    }
    
    // Handle tag input - enhanced with autocomplete is implemented above
    
    function addTag(tagText) {
      currentTags.push(tagText);
      renderTags();
    }
    
    function renderTags() {
      const container = document.getElementById('tags-container');
      container.innerHTML = '';
      
      currentTags.forEach(tag => {
        const tagElement = document.createElement('div');
        tagElement.classList.add('tag');
        tagElement.innerHTML = `
          <span>${tag}</span>
          <button type="button" data-tag="${tag}">✕</button>
        `;
        container.appendChild(tagElement);
        
        // Add event listener to remove tag
        tagElement.querySelector('button').addEventListener('click', (e) => {
          const tagToRemove = e.target.dataset.tag;
          currentTags = currentTags.filter(t => t !== tagToRemove);
          renderTags();
        });
      });
    }
    
    // Cancel button
    document.getElementById('cancel').addEventListener('click', () => {
      // Reset form
      resetForm();
      
      // Hide the form panel
      document.getElementById('decision-form-panel').classList.remove('active');
      
      // Show the "New Decision" button again
      document.getElementById('new-decision-btn').style.display = 'flex';
      
      // Allow body scrolling
      document.body.classList.remove('modal-open');
    });
    
    // Resource Form Functions
    function showResourceForm() {
      // Reset the resource form first
      resetResourceForm();
      // Set title to "New Resource" if not editing
      if (!editingResourceId) {
        document.getElementById('resource-form-title').textContent = 'New Resource';
      }
      // Reset scroll position to the top
      document.getElementById('resource-form').scrollTop = 0;
      // Show the form panel
      document.getElementById('resource-form-panel').classList.add('active');
      // Hide the "New Resource" button when form is shown
      document.getElementById('new-resource-btn').style.display = 'none';
      // Prevent body scrolling
      document.body.classList.add('modal-open');
    }
    
    function hideResourceForm() {
      document.getElementById('resource-form-panel').classList.remove('active');
      // Reset the form when hiding
      resetResourceForm();
      // Show the "New Resource" button when form is closed
      if (activeTab === 'resources') {
        document.getElementById('new-resource-btn').style.display = 'flex';
      }
      // Allow body scrolling
      document.body.classList.remove('modal-open');
    }
    
    function resetResourceForm() {
      // Reset form and editing state
      document.getElementById('resource-form').reset();
      currentResourceTags = [];
      renderResourceTags();
      editingResourceId = null;
      document.getElementById('save-resource').textContent = 'Save Resource';
    }
    
    // Close resource form panel
    document.getElementById('resource-form-close').addEventListener('click', hideResourceForm);
    
    // Cancel resource button
    document.getElementById('cancel-resource').addEventListener('click', hideResourceForm);
    
    // Handle resource form submission
    document.getElementById('resource-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const title = document.getElementById('resource-title').value;
      const description = document.getElementById('resource-description').value;
      const url = document.getElementById('resource-url').value;
      const category = document.getElementById('resource-category').value;
      
      // Check if we're editing or creating
      if (editingResourceId) {
        // Editing an existing resource
        parent.postMessage({
          pluginMessage: {
            type: 'edit-resource',
            resource: {
              id: editingResourceId,
              title,
              description,
              url,
              category,
              tags: currentResourceTags
            }
          }
        }, '*');
      } else {
        // Creating a new resource
        parent.postMessage({
          pluginMessage: {
            type: 'create-resource',
            title,
            description,
            url,
            category,
            tags: currentResourceTags
          }
        }, '*');
      }
      
      // Hide the form panel after submission
      document.getElementById('resource-form-panel').classList.remove('active');
      
      // Show the "New Resource" button again after submission if we're on the resources tab
      if (activeTab === 'resources') {
        document.getElementById('new-resource-btn').style.display = 'flex';
      }
      
      // Allow body scrolling
      document.body.classList.remove('modal-open');
    });
    
    // Handle resource tag input
    function addResourceTag(tagText) {
      currentResourceTags.push(tagText);
      renderResourceTags();
    }
    
    function renderResourceTags() {
      const container = document.getElementById('resource-tags-container');
      container.innerHTML = '';
      
      currentResourceTags.forEach(tag => {
        const tagElement = document.createElement('div');
        tagElement.classList.add('tag');
        tagElement.innerHTML = `
          <span>${tag}</span>
          <button type="button" data-tag="${tag}">✕</button>
        `;
        container.appendChild(tagElement);
        
        // Add event listener to remove tag
        tagElement.querySelector('button').addEventListener('click', (e) => {
          const tagToRemove = e.target.dataset.tag;
          currentResourceTags = currentResourceTags.filter(t => t !== tagToRemove);
          renderResourceTags();
        });
      });
    }
    
    // Resource tag input handling
    document.getElementById('resource-tag-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const input = document.getElementById('resource-tag-input');
        const tagText = input.value.trim();
        
        if (tagText && !currentResourceTags.includes(tagText)) {
          addResourceTag(tagText);
          input.value = '';
          
          // Add to global tags set for future autocomplete
          allUniqueTags.add(tagText);
        }
      }
    });
    
    // Render resources list
    function renderResourcesList(resourcesToRender = resources) {
      const container = document.getElementById('resource-list');
      container.innerHTML = '';
      
      if (resourcesToRender.length === 0) {
        container.innerHTML = '<div class="empty-state">No resources added yet.</div>';
        return;
      }
      
      // Sort resources alphabetically by default
      resourcesToRender.sort((a, b) => a.title.localeCompare(b.title));
      
      resourcesToRender.forEach(resource => {
        const card = document.createElement('div');
        card.classList.add('decision-card', 'resource-card');
        card.style.cursor = 'pointer';
        
        const date = new Date(resource.timestamp);
        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        
        card.innerHTML = `
          <div class="decision-header">
            <div class="decision-title">${resource.title}</div>
            <div class="tag resource-category-tag">${resource.category}</div>
          </div>
          <div class="decision-meta">
            By ${resource.author} on ${formattedDate}
          </div>
          <div class="decision-context">${resource.description}</div>
          ${resource.tags && resource.tags.length > 0 ? 
            `<div class="tags-container">
              ${resource.tags.map(tag => `<div class="tag"><span>${tag}</span></div>`).join('')}
            </div>` : ''}
        `;
        
        container.appendChild(card);
        
        // Make the card clickable
        card.addEventListener('click', () => {
          viewResourceDetails(resource.id);
        });
      });
    }
    
    // Function to show resource details
    function viewResourceDetails(id) {
      const resource = resources.find(r => r.id === id);
      if (!resource) return;
      
      currentDetailResourceId = id;
      
      // Hide the "New Resource" button when detail panel is shown
      document.getElementById('new-resource-btn').style.display = 'none';
      
      // Set details in the panel
      const detailPanel = document.getElementById('resource-detail-panel');
      
      // Reset scroll position of the content area
      document.querySelector('#resource-detail-panel .decision-detail-panel-content').scrollTop = 0;
      
      // Basic info
      document.getElementById('resource-detail-title').textContent = resource.title;
      
      // Category
      const categoryElement = document.getElementById('resource-detail-category');
      categoryElement.textContent = resource.category.charAt(0).toUpperCase() + resource.category.slice(1);
      categoryElement.className = 'tag resource-category-tag';
      
      // Format date
      const date = new Date(resource.timestamp);
      const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      
      document.getElementById('resource-detail-author').textContent = `By ${resource.author}`;
      document.getElementById('resource-detail-date').textContent = `On ${formattedDate}`;
      
      // Set description
      document.getElementById('resource-detail-description').textContent = resource.description;
      
      // Set link
      const linkElement = document.getElementById('resource-detail-link');
      
      // Ensure the URL is valid and properly formatted
      let url = resource.url;
      
      // If URL is empty, # or undefined, use a placeholder
      if (!url || url === '#') {
        url = 'https://missing-url.com';
      }
      // If URL doesn't have protocol, add https://
      else if (!/^https?:\/\//i.test(url)) {
        url = 'https://' + url;
      }
      
      linkElement.href = url;
      linkElement.textContent = resource.title;
      
      // Tags section
      const tagsSection = document.getElementById('resource-detail-tags-section');
      const tagsContainer = document.getElementById('resource-detail-tags');
      
      if (resource.tags && resource.tags.length > 0) {
        tagsSection.style.display = 'block';
        tagsContainer.innerHTML = '';
        
        resource.tags.forEach(tag => {
          const tagElement = document.createElement('div');
          tagElement.classList.add('tag');
          tagElement.innerHTML = `<span>${tag}</span>`;
          tagsContainer.appendChild(tagElement);
        });
      } else {
        tagsSection.style.display = 'none';
      }
      
      // Set up visit button
      const visitButton = document.getElementById('resource-detail-visit-button');
      visitButton.onclick = () => {
        // Ensure the URL is valid and properly formatted
        let url = resource.url;
        
        // If URL is empty, # or undefined, use a placeholder
        if (!url || url === '#') {
          url = 'https://missing-url.com';
        }
        // If URL doesn't have protocol, add https://
        else if (!/^https?:\/\//i.test(url)) {
          url = 'https://' + url;
        }
        
        window.open(url, '_blank');
      };
      
      // Set up action buttons - first remove any existing event listeners by cloning and replacing
      const editButton = document.getElementById('resource-detail-edit-button');
      const newEditButton = editButton.cloneNode(true);
      editButton.parentNode.replaceChild(newEditButton, editButton);
      newEditButton.addEventListener('click', () => {
        detailPanel.classList.remove('active');
        // Allow body scrolling when closing the panel, but it will be prevented again when the edit form opens
        document.body.classList.remove('modal-open');
        editResource(resource.id);
      });
      
      const deleteButton = document.getElementById('resource-detail-delete-button');
      const newDeleteButton = deleteButton.cloneNode(true);
      deleteButton.parentNode.replaceChild(newDeleteButton, deleteButton);
      newDeleteButton.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this resource?')) {
          detailPanel.classList.remove('active');
          // Allow body scrolling when closing the panel
          document.body.classList.remove('modal-open');
          deleteResource(resource.id);
        }
      });
      
      // Set up close button
      const closeButton = document.getElementById('resource-detail-close');
      const newCloseButton = closeButton.cloneNode(true);
      closeButton.parentNode.replaceChild(newCloseButton, closeButton);
      newCloseButton.addEventListener('click', () => {
        detailPanel.classList.remove('active');
        currentDetailResourceId = null;
        
        // Ensure the "New Resource" button is shown when detail panel is closed
        if (activeTab === 'resources') {
          document.getElementById('new-resource-btn').style.display = 'flex';
        }
        
        // Allow body scrolling
        document.body.classList.remove('modal-open');
      });
      
      // Show the panel with animation
      detailPanel.classList.add('active');
      
      // Prevent body scrolling
      document.body.classList.add('modal-open');
    }
    
    // Edit resource function
    function editResource(id) {
      // Load the resource data into the form and switch to edit mode
      const resource = resources.find(r => r.id === id);
      if (!resource) return;
      
      editingResourceId = id;
      
      // Update form title
      document.getElementById('resource-form-title').textContent = 'Edit Resource';
      
      // Fill in the form fields
      document.getElementById('resource-title').value = resource.title;
      document.getElementById('resource-description').value = resource.description;
      document.getElementById('resource-url').value = resource.url;
      document.getElementById('resource-category').value = resource.category;
      
      // Set the tags
      currentResourceTags = resource.tags ? [...resource.tags] : [];
      renderResourceTags();
      
      // Change button text
      document.getElementById('save-resource').textContent = 'Update Resource';
      
      // Reset scroll position to the top
      document.getElementById('resource-form').scrollTop = 0;
      
      // Show the form panel
      document.getElementById('resource-form-panel').classList.add('active');
      
      // Hide the "New Resource" button
      document.getElementById('new-resource-btn').style.display = 'none';
    }
    
    // Delete resource function
    function deleteResource(id) {
      parent.postMessage({
        pluginMessage: {
          type: 'delete-resource',
          id
        }
      }, '*');
    }
    
    // Resource search and filter
    document.getElementById('resource-search-input').addEventListener('input', filterResources);
    document.getElementById('resource-category-filter').addEventListener('change', filterResources);
    
    function filterResources() {
      const searchText = document.getElementById('resource-search-input').value.toLowerCase();
      const categoryFilter = document.getElementById('resource-category-filter').value;
      
      const filtered = resources.filter(resource => {
        // Search text filter
        const matchesSearch = searchText === '' || 
          resource.title.toLowerCase().includes(searchText) || 
          resource.description.toLowerCase().includes(searchText);
        
        // Category filter
        const matchesCategory = categoryFilter === '' || resource.category === categoryFilter;
        
        return matchesSearch && matchesCategory;
      });
      
      renderResourcesList(filtered);
    }
    
    // Search and filter functionality
    document.getElementById('search-input').addEventListener('input', filterDecisions);
    document.getElementById('filter-tags').addEventListener('change', filterDecisions);
    document.getElementById('filter-status').addEventListener('change', filterDecisions);
    document.getElementById('sort-decisions').addEventListener('change', filterDecisions);
    
    function filterDecisions() {
      const searchText = document.getElementById('search-input').value.toLowerCase();
      const tagFilter = document.getElementById('filter-tags').value;
      const statusFilter = document.getElementById('filter-status').value;
      const sortOption = document.getElementById('sort-decisions').value;
      
      const filtered = decisions.filter(decision => {
        // Search text filter
        const matchesSearch = searchText === '' || 
          decision.title.toLowerCase().includes(searchText) || 
          decision.context.toLowerCase().includes(searchText) || // Searches in Decision Details
          decision.rationale.toLowerCase().includes(searchText);
        
        // Tag filter
        const matchesTag = tagFilter === '' || 
          (decision.tags && decision.tags.includes(tagFilter));
        
        // Status filter
        const matchesStatus = statusFilter === '' || decision.status === statusFilter;
        
        return matchesSearch && matchesTag && matchesStatus;
      });
      
      renderDecisionsList(filtered, sortOption);
    }
    
    // Render decisions list
    function renderDecisionsList(decisionsToRender = decisions, sortOption = 'newest') {
      const container = document.getElementById('decision-list');
      container.innerHTML = '';
      
      if (decisionsToRender.length === 0) {
        container.innerHTML = '<div class="empty-state">No decisions found.</div>';
        return;
      }
      
      // Sort decisions based on the selected sort option
      decisionsToRender.sort((a, b) => {
        switch (sortOption) {
          case 'newest':
            return b.timestamp - a.timestamp;
          case 'oldest':
            return a.timestamp - b.timestamp;
          case 'az':
            return a.title.localeCompare(b.title);
          case 'za':
            return b.title.localeCompare(a.title);
          default:
            return b.timestamp - a.timestamp;
        }
      });
      
      decisionsToRender.forEach(decision => {
        const card = document.createElement('div');
        card.classList.add('decision-card');
        // Add status class for left border color
        card.classList.add('status-' + (decision.status || 'proposed').toLowerCase());
        // Make the entire card clickable by adding cursor pointer style
        card.style.cursor = 'pointer';
        
        const date = new Date(decision.timestamp);
        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        
        // Prepare the Figma node link section if it exists
        let figmaNodeSection = '';
        if (decision.nodeId && decision.nodeName) {
          const pageNameDisplay = decision.pageName ? 
            `<span style="color: #888; margin-right: 5px; font-size: 11px; display: inline-block;">${decision.pageName}</span>` : '';
            
          figmaNodeSection = `
            <div class="figma-node-link" style="margin-top: 8px;">
              <div class="tag" style="background-color: #E9F5FF; color: #007ACC; display: inline-flex; cursor: pointer;" data-node-id="${decision.nodeId}" data-page-name="${decision.pageName || ''}">
                ${pageNameDisplay}
                <span>${decision.nodeName}</span>
              </div>
            </div>`;
        }
        
        card.innerHTML = `
          <div class="decision-header">
            <div class="decision-title">${decision.title}</div>
            <div class="status-badge status-${(decision.status || 'proposed').toLowerCase()}">${decision.status || 'Proposed'}</div>
          </div>
          <div class="decision-meta">
            By ${decision.author} on ${formattedDate}
          </div>
          <div class="decision-context">${decision.context}</div>
          ${decision.tags && decision.tags.length > 0 ? 
            `<div class="tags-container">
              ${decision.tags.map(tag => `<div class="tag"><span>${tag}</span></div>`).join('')}
            </div>` : ''}
          ${figmaNodeSection}
        `;
        
        container.appendChild(card);
        
        // Make the entire card clickable to view details and navigate to linked element
        card.addEventListener('click', (e) => {
          // First, open the details panel
          viewDecisionDetails(decision.id);
          
          // If there's a linked element, also navigate to it
          if (decision.nodeId) {
            // If we're clicking directly on the node link tag, don't double-navigate
            if (!e.target.closest('.figma-node-link .tag')) {
              navigateToNode(decision.nodeId, decision.pageName);
            }
          }
        });
      });
    }
    
    // Function to navigate to a Figma node
    function navigateToNode(nodeId, pageName) {
      if (!nodeId) return;
      
      parent.postMessage({
        pluginMessage: {
          type: 'navigate-to-node',
          nodeId,
          pageName
        }
      }, '*');
    }
    
    // Function to show the detail panel
    function viewDecisionDetails(id) {
      // Find the decision with the given ID
      const decision = decisions.find(d => d.id === id);
      if (!decision) return;
      
      currentDetailDecisionId = id;
      
      // Set details in the panel
      const detailPanel = document.getElementById('decision-detail-panel');
      
      // Reset scroll position of the content area
      document.querySelector('#decision-detail-panel .decision-detail-panel-content').scrollTop = 0;
      
      // Hide the "New Decision" button when detail panel is shown
      document.getElementById('new-decision-btn').style.display = 'none';
      
      // Set basic info
      document.getElementById('detail-title').textContent = decision.title;
      
      // Set status with proper styling
     
      const statusElement = document.getElementById('detail-status');
      const statusText = decision.status || 'Proposed';
      const statusClass = `status-${statusText.toLowerCase()}`;
      statusElement.textContent = statusText;
      statusElement.className = 'status-badge ' + statusClass;
      
      // Format date
      const date = new Date(decision.timestamp);
      const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      
      document.getElementById('detail-author').textContent = `By ${decision.author}`;
      document.getElementById('detail-date').textContent = `On ${formattedDate}`;
      
      // Set content
      document.getElementById('detail-context').textContent = decision.context;
      document.getElementById('detail-rationale').textContent = decision.rationale;
      
      // Handle links section
      const linksSection = document.getElementById('detail-links-section');
      const linksContainer = document.getElementById('detail-links');
      
      if (decision.links && decision.links.length > 0) {
        linksSection.style.display = 'block';
        linksContainer.innerHTML = '';
        
        decision.links.forEach(link => {
          const linkElement = document.createElement('a');
          linkElement.classList.add('detail-link');
          linkElement.href = link.url;
          linkElement.target = '_blank';
          linkElement.textContent = link.title;
          linksContainer.appendChild(linkElement);
        });
      } else {
        linksSection.style.display = 'none';
      }
      
      // Handle pros and cons section
      const prosConsSection = document.getElementById('detail-pros-cons-section');
      const prosList = document.getElementById('detail-pros');
      const consList = document.getElementById('detail-cons');
      
      if ((decision.pros && decision.pros.length > 0) || (decision.cons && decision.cons.length > 0)) {
        prosConsSection.style.display = 'block';
        
        // Populate pros
        prosList.innerHTML = '';
        if (decision.pros && decision.pros.length > 0) {
          decision.pros.forEach(pro => {
                       const li = document.createElement('li');
            li.textContent = pro;
            prosList.appendChild(li);
          });
        } else {
          prosList.innerHTML = '<li style="font-style: italic; color: #888;">None specified</li>';
        }
        
        // Populate cons
        consList.innerHTML = '';
        if (decision.cons && decision.cons.length > 0) {
          decision.cons.forEach(con => {
            const li = document.createElement('li');
            li.textContent = con;
            consList.appendChild(li);
          });
        } else {
          consList.innerHTML = '<li style="font-style: italic; color: #888;">None specified</li>';
        }
      } else {
        prosConsSection.style.display = 'none';
      }
      
      // Handle tags section
      const tagsSection = document.getElementById('detail-tags-section');
      const tagsContainer = document.getElementById('detail-tags');
      
      if (decision.tags && decision.tags.length > 0) {
        tagsSection.style.display = 'block';
        tagsContainer.innerHTML = '';
        
        decision.tags.forEach(tag => {
          const tagElement = document.createElement('div');
          tagElement.classList.add('tag');
          tagElement.innerHTML = `<span>${tag}</span>`;
          tagsContainer.appendChild(tagElement);
        });
      } else {
        tagsSection.style.display = 'none';
      }
      
      // Handle linked node section
      const nodeSection = document.getElementById('detail-node-section');
      const nodeContainer = document.getElementById('detail-node-info');
      
      if (decision.nodeId && decision.nodeName) {
        nodeSection.style.display = 'block';
        const pageNameDisplay = decision.pageName ? 
          `<span style="color: #888; margin-right: 5px; font-size: 11px; display: inline-block;">${decision.pageName}</span>` : '';
          
        nodeContainer.innerHTML = `
          <div class="tag" style="background-color: #E9F5FF; color: #007ACC; display: inline-flex; cursor: pointer;" data-node-id="${decision.nodeId}">
            ${pageNameDisplay}
            <span>${decision.nodeName}</span>
          </div>
        `;
        
        // Add click event to the node tag (the container is freshly created each time, so no need to worry about duplicate listeners)
        nodeContainer.querySelector('.tag').addEventListener('click', () => {
          navigateToNode(decision.nodeId, decision.pageName);
          // Close the detail panel after navigating
          detailPanel.classList.remove('active');
          
          // Allow body scrolling when closing the panel
          document.body.classList.remove('modal-open');
          
          // Show the "New Decision" button again when closing detail panel (if on decisions tab)
          if (activeTab === 'decisions') {
            document.getElementById('new-decision-btn').style.display = 'flex';
          }
        });
        
        // Show the navigate button
        document.getElementById('detail-navigate-button').style.display = 'inline-block';
      } else {
        nodeSection.style.display = 'none';
        // Hide the navigate button if there's no linked node
        document.getElementById('detail-navigate-button').style.display = 'none';
      }
      
      // Set up action buttons - first remove any existing event listeners by cloning and replacing
      const editButton = document.getElementById('detail-edit-button');
      const newEditButton = editButton.cloneNode(true);
      editButton.parentNode.replaceChild(newEditButton, editButton);
      newEditButton.addEventListener('click', () => {
        detailPanel.classList.remove('active');
        // Allow body scrolling when closing the panel, but it will be prevented again when the edit form opens
        document.body.classList.remove('modal-open');
        editDecision(decision.id);
        // No need to show the "New Decision" button as editDecision will keep it hidden
      });
      
      const deleteButton = document.getElementById('detail-delete-button');
      const newDeleteButton = deleteButton.cloneNode(true);
      deleteButton.parentNode.replaceChild(newDeleteButton, deleteButton);
      newDeleteButton.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this decision?')) {
          detailPanel.classList.remove('active');
          // Allow body scrolling when closing the panel
          document.body.classList.remove('modal-open');
          deleteDecision(decision.id);
          
          // Show the "New Decision" button again when deleting a decision (if on decisions tab)
          if (activeTab === 'decisions') {
            document.getElementById('new-decision-btn').style.display = 'flex';
          }
        }
      });
      
      // Set up close button - first remove any existing event listeners by cloning and replacing
      const closeButton = document.getElementById('detail-close');
      const newCloseButton = closeButton.cloneNode(true);
      closeButton.parentNode.replaceChild(newCloseButton, closeButton);
      newCloseButton.addEventListener('click', () => {
        detailPanel.classList.remove('active');
        currentDetailDecisionId = null;
        
        // Ensure the "New Decision" button is shown when detail panel is closed
        // Only if the form panel is not active and we're on the decisions tab
        if (!document.getElementById('decision-form-panel').classList.contains('active') && activeTab === 'decisions') {
          document.getElementById('new-decision-btn').style.display = 'flex';
        }
        
        // Allow body scrolling
        document.body.classList.remove('modal-open');
      });
      
      // Handle navigate button click - first remove any existing event listeners by cloning and replacing
      const navigateButton = document.getElementById('detail-navigate-button');
      const newNavigateButton = navigateButton.cloneNode(true);
      navigateButton.parentNode.replaceChild(newNavigateButton, navigateButton);
      newNavigateButton.onclick = () => {
        if (decision.nodeId) {
          navigateToNode(decision.nodeId, decision.pageName);
          // Close the detail panel after navigating
          detailPanel.classList.remove('active');
          
          // Show the "New Decision" button again when closing detail panel (if on decisions tab)
          if (activeTab === 'decisions') {
            document.getElementById('new-decision-btn').style.display = 'flex';
          }
          
          // Allow body scrolling when closing the panel
          document.body.classList.remove('modal-open');
        }
      };
      
      // Show the panel with animation
      detailPanel.classList.add('active');
      
      // Prevent body scrolling
      document.body.classList.add('modal-open');
    }
    
    function editDecision(id) {
      // Load the decision data into the form and switch to the edit mode
      const decision = decisions.find(d => d.id === id);
      if (!decision) return;
      
      editingDecisionId = id;
      
      // Update the form title
      document.getElementById('form-title').textContent = 'Edit Decision';
      
      document.getElementById('title').value = decision.title;
      document.getElementById('context').value = decision.context;
      document.getElementById('rationale').value = decision.rationale;
      document.getElementById('status').value = decision.status;
      
      // Set selected node info
      selectedNodeId = decision.nodeId || null;
      selectedNodeName = decision.nodeName || null;
      selectedPageName = decision.pageName || null;
      
      // Update the node info display in the form
      const noSelectionElement = document.getElementById('no-selection');
      const nodeSelectionElement = document.getElementById('node-selection');
      
      if (selectedNodeId && selectedNodeName) {
        noSelectionElement.style.display = 'none';
        nodeSelectionElement.style.display = 'block';
        document.getElementById('node-name').textContent = selectedNodeName;
        document.getElementById('node-page').textContent = selectedPageName || '';
      } else {
        noSelectionElement.style.display = 'block';
        nodeSelectionElement.style.display = 'none';
      }
      
      // Clear existing fields
      document.getElementById('links-container').innerHTML = '';
      document.getElementById('pros-container').innerHTML = '';
      document.getElementById('cons-container').innerHTML = '';
      currentTags = [];
      
      // Add links
      if (decision.links && decision.links.length > 0) {
        decision.links.forEach(link => {
          const container = document.getElementById('links-container');
          const linkItem = document.createElement('div');
          linkItem.classList.add('link-item');
          linkItem.innerHTML = `
            <input type="text" placeholder="Title" class="link-title" value="${link.title}">
            <input type="text" placeholder="URL" class="link-url" value="${link.url}">
            <button type="button" class="button secondary remove-link">✕</button>
          `;
          container.appendChild(linkItem);
          
          // Add event listener to the remove button
          linkItem.querySelector('.remove-link').addEventListener('click', () => {
            container.removeChild(linkItem);
          });
        });
      } else {
        // Add an empty link field
        addLinkField();
      }
      
      // Add pros
      if (decision.pros && decision.pros.length > 0) {
        decision.pros.forEach(pro => {
          const container = document.getElementById('pros-container');
          const listItem = document.createElement('div');
          listItem.classList.add('list-item');
          listItem.innerHTML = `
            <input type="text" class="pro-item" value="${pro}">
            <button type="button" class="button secondary remove-item">✕</button>
          `;
          container.appendChild(listItem);
          
          // Add event listener to the remove button
          listItem.querySelector('.remove-item').addEventListener('click', () => {
            container.removeChild(listItem);
          });
        });
      } else {
        // Add an empty pro field
        addListItem('pros-container', 'pro-item');
      }
      
      // Add cons
      if (decision.cons && decision.cons.length > 0) {
        decision.cons.forEach(con => {
          const container = document.getElementById('cons-container');
          const listItem = document.createElement('div');
          listItem.classList.add('list-item');
          listItem.innerHTML = `
            <input type="text" class="con-item" value="${con}">
            <button type="button" class="button secondary remove-item">✕</button>
          `;
          container.appendChild(listItem);
          
          // Add event listener to the remove button
          listItem.querySelector('.remove-item').addEventListener('click', () => {
            container.removeChild(listItem);
          });
        });
      } else {
        // Add an empty con field
        addListItem('cons-container', 'con-item');
      }
      
      // Add tags
      if (decision.tags && decision.tags.length > 0) {
        currentTags = [...decision.tags];
        renderTags();
      }
      
      // Change button text and switch to new decision tab
      document.getElementById('save-decision').textContent = 'Update Decision';
      // Reset scroll position to the top
      document.getElementById('decision-form').scrollTop = 0;
      document.getElementById('decision-form-panel').classList.add('active');
      
      // Hide the "New Decision" button when editing a decision
      document.getElementById('new-decision-btn').style.display = 'none';
      
      // Prevent body scrolling
      document.body.classList.add('modal-open');
    }
    
    function deleteDecision(id) {
      // Delete the decision
      parent.postMessage({
        pluginMessage: {
          type: 'delete-decision',
          id
        }
      }, '*');
    }
    
    // Populate the tag filter dropdown
    function populateTagFilter() {
      const dropdown = document.getElementById('filter-tags');
      dropdown.innerHTML = '<option value="">All tags</option>';
      
      // Also update all unique tags for autocomplete
      allUniqueTags = new Set();
      
      decisions.forEach(decision => {
        if (decision.tags) {
          decision.tags.forEach(tag => allUniqueTags.add(tag));
        }
      });
      
      Array.from(allUniqueTags).sort().forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        dropdown.appendChild(option);
      });
    }
    
    // Handle tag input - updating with autocomplete feature
    document.getElementById('tag-input').addEventListener('input', showTagSuggestions);
    document.getElementById('tag-input').addEventListener('keydown', handleTagInputKeydown);
    document.getElementById('tag-input').addEventListener('blur', hideTagSuggestions);
    
    // Show tag suggestions based on current input
    function showTagSuggestions(e) {
      const input = e.target;
      const tagText = input.value.trim();
      
      if (tagText.length === 0) {
        hideTagSuggestions();
        return;
      }
      
      // Filter tags that match the input
      currentTagSuggestions = Array.from(allUniqueTags)
        .filter(tag => 
          tag.toLowerCase().includes(tagText.toLowerCase()) && 
          !currentTags.includes(tag)
        )
        .sort();
      
      const suggestionsContainer = document.getElementById('tag-suggestions');
      suggestionsContainer.innerHTML = '';
      
      if (currentTagSuggestions.length > 0) {
        currentTagSuggestions.forEach((tag, index) => {
          const suggestionElement = document.createElement('div');
          suggestionElement.classList.add('tag-suggestion');
          suggestionElement.textContent = tag;
          suggestionElement.addEventListener('mousedown', (e) => {
            // Using mousedown instead of click to prevent blur from firing first
            e.preventDefault();
            selectTagSuggestion(tag);
          });
          suggestionsContainer.appendChild(suggestionElement);
        });
        
        suggestionsContainer.classList.add('visible');
        highlightedSuggestionIndex = -1; // Reset highlighted suggestion
      } else {
        suggestionsContainer.classList.remove('visible');
      }
    }
    
    // Handle keyboard navigation in tag suggestions
    function handleTagInputKeydown(e) {
      const suggestionsContainer = document.getElementById('tag-suggestions');
      const suggestions = suggestionsContainer.querySelectorAll('.tag-suggestion');
      
      if (suggestions.length === 0) {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const input = document.getElementById('tag-input');
          const tagText = input.value.trim();
          
          if (tagText && !currentTags.includes(tagText)) {
            addTag(tagText);
            input.value = '';
          }
        }
        return;
      }
      
      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          highlightedSuggestionIndex = (highlightedSuggestionIndex + 1) % suggestions.length;
          updateHighlightedSuggestion();
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          highlightedSuggestionIndex = (highlightedSuggestionIndex - 1 + suggestions.length) % suggestions.length;
          updateHighlightedSuggestion();
          break;
          
        case 'Enter':
        case 'Tab':
          if (highlightedSuggestionIndex >= 0) {
            e.preventDefault();
            selectTagSuggestion(currentTagSuggestions[highlightedSuggestionIndex]);
          } else if (e.key === 'Enter') {
            e.preventDefault();
            const input = document.getElementById('tag-input');
            const tagText = input.value.trim();
            
            if (tagText && !currentTags.includes(tagText)) {
              addTag(tagText);
              input.value = '';
              hideTagSuggestions();
            }
          }
          break;
          
        case ',':
          e.preventDefault();
          const input = document.getElementById('tag-input');
          const tagText = input.value.trim();
          
          if (tagText && !currentTags.includes(tagText)) {
            addTag(tagText);
            input.value = '';
            hideTagSuggestions();
          }
          break;
          
        case 'Escape':
          e.preventDefault();
          hideTagSuggestions();
          break;
      }
    }
    
    // Update which suggestion is highlighted
    function updateHighlightedSuggestion() {
      const suggestions = document.querySelectorAll('.tag-suggestion');
      
      suggestions.forEach((suggestion, index) => {
        if (index === highlightedSuggestionIndex) {
          suggestion.classList.add('highlighted');
        } else {
          suggestion.classList.remove('highlighted');
        }
      });
    }
    
    // Select a tag suggestion and add it
    function selectTagSuggestion(tag) {
      if (tag && !currentTags.includes(tag)) {
        addTag(tag);
        document.getElementById('tag-input').value = '';
        hideTagSuggestions();
        document.getElementById('tag-input').focus(); // Keep focus on the input
      }
    }
    
    // Hide the tag suggestions dropdown
    function hideTagSuggestions() {
      setTimeout(() => {
        document.getElementById('tag-suggestions').classList.remove('visible');
      }, 100); // Small delay to allow for click to register on suggestion
    }
    
    // Message handler from the plugin code
    onmessage = (event) => {
      const message = event.data.pluginMessage;
      
      if (!message) return;
      
      switch (message.type) {
        case 'load-decisions':
          decisions = message.decisions || [];
          // Store the document ID for deep links
          if (message.documentId) {
            currentDocumentId = message.documentId;
            console.log('Received document ID:', currentDocumentId);
          }
          // Store the file name for URLs
          if (message.fileName) {
            setFileName(message.fileName);
            console.log('Received file name:', message.fileName);
          }
          renderDecisionsList();
          populateTagFilter(); // This now also extracts all unique tags for autocomplete
          break;
          
        case 'load-resources':
          resources = message.resources || [];
          renderResourcesList();
          break;
          
        case 'selection-info':
          // Update the UI to show the currently selected node
          selectedNodeId = message.nodeId;
          selectedNodeName = message.nodeName;
          selectedPageName = message.pageName;
          
          const noSelectionElement = document.getElementById('no-selection');
          const nodeSelectionElement = document.getElementById('node-selection');
          
          if (selectedNodeId && selectedNodeName) {
            // Show the selected node info
            noSelectionElement.style.display = 'none';
            nodeSelectionElement.style.display = 'block';
            document.getElementById('node-name').textContent = selectedNodeName;
            document.getElementById('node-page').textContent = selectedPageName || '';
          } else {
            // Show the "no selection" message
            noSelectionElement.style.display = 'block';
            nodeSelectionElement.style.display = 'none';
          }
          break;          case 'decision-created':
          decisions.push(message.decision);
          // Reset form
          resetForm();
          // Hide form panel and update the list
          document.getElementById('decision-form-panel').classList.remove('active');
          // Make sure the New Decision button is visible
          document.getElementById('new-decision-btn').style.display = 'flex';
          renderDecisionsList();
          populateTagFilter(); // This also updates tag suggestions
          break;
          
        case 'resource-created':
          resources.push(message.resource);
          // Reset form
          resetResourceForm();
          // Hide form panel and update the list
          document.getElementById('resource-form-panel').classList.remove('active');
          // Make sure the New Resource button is visible if we're on resources tab
          if (activeTab === 'resources') {
            document.getElementById('new-resource-btn').style.display = 'flex';
          }
          renderResourcesList();
          // Add any new tags to the global tag set
          if (message.resource.tags) {
            message.resource.tags.forEach(tag => allUniqueTags.add(tag));
          }
          break;          case 'decision-updated':
          const index = decisions.findIndex(d => d.id === message.decision.id);
          if (index !== -1) {
            decisions[index] = message.decision;
            
            // If the detail panel is showing this decision, update it
            if (currentDetailDecisionId === message.decision.id) {
              viewDecisionDetails(message.decision.id);
            }
          }
          // Reset edit mode
          editingDecisionId = null;
          document.getElementById('save-decision').textContent = 'Save Decision';
          // Hide form panel and update the list
          document.getElementById('decision-form-panel').classList.remove('active');
          // Make sure the New Decision button is visible
          document.getElementById('new-decision-btn').style.display = 'flex';
          renderDecisionsList();
          populateTagFilter(); // This also updates tag suggestions
          break;
          
        case 'resource-updated':
          const resourceIndex = resources.findIndex(r => r.id === message.resource.id);
          if (resourceIndex !== -1) {
            resources[resourceIndex] = message.resource;
            
            // If the detail panel is showing this resource, update it
            if (currentDetailResourceId === message.resource.id) {
              viewResourceDetails(message.resource.id);
            }
          }
          // Reset edit mode
          editingResourceId = null;
          document.getElementById('save-resource').textContent = 'Save Resource';
          // Hide form panel and update the list
          document.getElementById('resource-form-panel').classList.remove('active');
          // Make sure the New Resource button is visible if we're on resources tab
          if (activeTab === 'resources') {
            document.getElementById('new-resource-btn').style.display = 'flex';
          }
          renderResourcesList();
          // Update global tag set
          if (message.resource.tags) {
            message.resource.tags.forEach(tag => allUniqueTags.add(tag));
          }
          break;          case 'decision-deleted':
          decisions = decisions.filter(d => d.id !== message.id);
          
          // If the detail panel is showing this decision, close it
          if (currentDetailDecisionId === message.id) {
            document.getElementById('decision-detail-panel').classList.remove('active');
            currentDetailDecisionId = null;
          }
          
          renderDecisionsList();
          populateTagFilter(); // This also updates tag suggestions
          break;
          
        case 'resource-deleted':
          resources = resources.filter(r => r.id !== message.id);
          
          // If the detail panel is showing this resource, close it
          if (currentDetailResourceId === message.id) {
            document.getElementById('resource-detail-panel').classList.remove('active');
            currentDetailResourceId = null;
            
            // Make sure the New Resource button is visible if we're on resources tab
            if (activeTab === 'resources') {
              document.getElementById('new-resource-btn').style.display = 'flex';
            }
          }
          
          renderResourcesList();
          break;
          
        case 'user-info':
          currentUser = {
            name: message.name,
            id: message.id
          };
          break;
          
        case 'document-id':
          currentDocumentId = message.documentId;
          if (message.fileName) {
            setFileName(message.fileName);
            console.log('Received file name:', message.fileName);
          }
          console.log('Received document ID via explicit request:', currentDocumentId);
          break;
      }
    };
    
    // Initialize
    addLinkField();
    addListItem('pros-container', 'pro-item');
    addListItem('cons-container', 'con-item');
    
    // Make sure the New Decision button is initially visible
    document.getElementById('new-decision-btn').style.display = 'flex';
    
    // Add some CSS for resource categories
    const style = document.createElement('style');
    style.textContent = `
      .resource-category-tag {
        background-color: #e9f5ff;
        color: #007ACC;
      }
      .resource-card {
        border-left: 4px solid #18a0fb;
      }
    `;
    document.head.appendChild(style);
    
    // Request resources data from the plugin
    parent.postMessage({ pluginMessage: { type: 'get-resources' } }, '*');
    
    // Tag suggestions logic
    document.getElementById('tag-input').addEventListener('input', (e) => {
      const value = e.target.value.trim();
      
      if (value === '') {
        // Hide suggestions when input is empty
        document.getElementById('tag-suggestions').classList.remove('visible');
        currentTagSuggestions = [];
        return;
      }
      
      // Filter suggestions based on input
      currentTagSuggestions = Array.from(allUniqueTags).filter(tag => 
        tag.toLowerCase().includes(value.toLowerCase())
      );
      
      // Show suggestions dropdown
      const suggestionsContainer = document.getElementById('tag-suggestions');
      suggestionsContainer.innerHTML = '';
      
      currentTagSuggestions.forEach((tag, index) => {
        const div = document.createElement('div');
        div.classList.add('tag-suggestion');
        div.textContent = tag;
        
        // Highlight suggestion on hover
        div.addEventListener('mouseenter', () => {
          highlightedSuggestionIndex = index;
          updateTagSuggestionHighlight();
        });
        
        // Select suggestion on click
        div.addEventListener('click', () => {
          addTag(tag);
          document.getElementById('tag-input').value = '';
          suggestionsContainer.classList.remove('visible');
        });
        
        suggestionsContainer.appendChild(div);
      });
      
      // Show the suggestions container
      suggestionsContainer.classList.add('visible');
      
      // Update highlight on arrow key navigation
      document.getElementById('tag-input').addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          highlightedSuggestionIndex = Math.min(highlightedSuggestionIndex + 1, currentTagSuggestions.length - 1);
          updateTagSuggestionHighlight();
          e.preventDefault();
        } else if (e.key === 'ArrowUp') {
          highlightedSuggestionIndex = Math.max(highlightedSuggestionIndex - 1, 0);
          updateTagSuggestionHighlight();
          e.preventDefault();
        } else if (e.key === 'Enter') {
          // Select highlighted suggestion on Enter
          if (highlightedSuggestionIndex >= 0 && highlightedSuggestionIndex < currentTagSuggestions.length) {
            const tag = currentTagSuggestions[highlightedSuggestionIndex];
            addTag(tag);
            document.getElementById('tag-input').value = '';
            document.getElementById('tag-suggestions').classList.remove('visible');
          }
        }
      });
    });
    
    function updateTagSuggestionHighlight() {
      const suggestions = document.querySelectorAll('.tag-suggestion');
      suggestions.forEach((s, index) => {
        if (index === highlightedSuggestionIndex) {
          s.classList.add('highlighted');
        } else {
          s.classList.remove('highlighted');
        }
      });
    }
  </script>
</body>
</html>
